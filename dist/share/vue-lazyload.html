<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue-lazyload源码阅读 | Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.8e5f961b.css" as="style"><link rel="preload" href="/assets/js/app.a68e905e.js" as="script"><link rel="preload" href="/assets/js/2.545454b5.js" as="script"><link rel="preload" href="/assets/js/4.dda20d7b.js" as="script"><link rel="prefetch" href="/assets/js/10.c3cf1c12.js"><link rel="prefetch" href="/assets/js/11.33587a7b.js"><link rel="prefetch" href="/assets/js/12.aff60a74.js"><link rel="prefetch" href="/assets/js/13.155a1953.js"><link rel="prefetch" href="/assets/js/14.0b1d1d72.js"><link rel="prefetch" href="/assets/js/15.efd7d200.js"><link rel="prefetch" href="/assets/js/16.1d7d243b.js"><link rel="prefetch" href="/assets/js/17.0579b7a7.js"><link rel="prefetch" href="/assets/js/18.30e65476.js"><link rel="prefetch" href="/assets/js/19.e2a0465c.js"><link rel="prefetch" href="/assets/js/20.c7213eb6.js"><link rel="prefetch" href="/assets/js/21.781d45ea.js"><link rel="prefetch" href="/assets/js/22.b83aaefb.js"><link rel="prefetch" href="/assets/js/23.d5ca9633.js"><link rel="prefetch" href="/assets/js/24.5c397418.js"><link rel="prefetch" href="/assets/js/25.634ab70c.js"><link rel="prefetch" href="/assets/js/26.85ea7d49.js"><link rel="prefetch" href="/assets/js/27.6056f0f9.js"><link rel="prefetch" href="/assets/js/28.29f349c6.js"><link rel="prefetch" href="/assets/js/29.9876f7ff.js"><link rel="prefetch" href="/assets/js/3.e1ad05a6.js"><link rel="prefetch" href="/assets/js/30.3a9cd144.js"><link rel="prefetch" href="/assets/js/31.00835958.js"><link rel="prefetch" href="/assets/js/32.76d09365.js"><link rel="prefetch" href="/assets/js/33.53d04d6e.js"><link rel="prefetch" href="/assets/js/34.285672ce.js"><link rel="prefetch" href="/assets/js/35.59fc3e90.js"><link rel="prefetch" href="/assets/js/36.51a28065.js"><link rel="prefetch" href="/assets/js/37.9afa9b43.js"><link rel="prefetch" href="/assets/js/38.76ee8f09.js"><link rel="prefetch" href="/assets/js/39.74b96b1a.js"><link rel="prefetch" href="/assets/js/40.bf9a8a1e.js"><link rel="prefetch" href="/assets/js/41.2c5d26f5.js"><link rel="prefetch" href="/assets/js/42.029fa221.js"><link rel="prefetch" href="/assets/js/43.8f5d1319.js"><link rel="prefetch" href="/assets/js/44.84525bb6.js"><link rel="prefetch" href="/assets/js/45.44ded8a3.js"><link rel="prefetch" href="/assets/js/46.c37a17f5.js"><link rel="prefetch" href="/assets/js/47.4af73619.js"><link rel="prefetch" href="/assets/js/48.de965b8f.js"><link rel="prefetch" href="/assets/js/49.4cc50a9d.js"><link rel="prefetch" href="/assets/js/5.b38ef4db.js"><link rel="prefetch" href="/assets/js/50.8d9e604a.js"><link rel="prefetch" href="/assets/js/51.37da19a3.js"><link rel="prefetch" href="/assets/js/52.a3446c3a.js"><link rel="prefetch" href="/assets/js/53.6f8564f2.js"><link rel="prefetch" href="/assets/js/54.61f6294c.js"><link rel="prefetch" href="/assets/js/55.13e07aad.js"><link rel="prefetch" href="/assets/js/56.8867fe90.js"><link rel="prefetch" href="/assets/js/57.e55257f4.js"><link rel="prefetch" href="/assets/js/58.6fa822d6.js"><link rel="prefetch" href="/assets/js/59.6e329073.js"><link rel="prefetch" href="/assets/js/6.d24e8dfb.js"><link rel="prefetch" href="/assets/js/60.0ca372ae.js"><link rel="prefetch" href="/assets/js/61.35403f53.js"><link rel="prefetch" href="/assets/js/62.4ab8be6d.js"><link rel="prefetch" href="/assets/js/63.2e275df4.js"><link rel="prefetch" href="/assets/js/64.6790785c.js"><link rel="prefetch" href="/assets/js/65.dde7c8e4.js"><link rel="prefetch" href="/assets/js/66.cd7f8acb.js"><link rel="prefetch" href="/assets/js/7.ee16b613.js"><link rel="prefetch" href="/assets/js/8.71ca7b19.js"><link rel="prefetch" href="/assets/js/9.6dc304b9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8e5f961b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/base/" class="nav-link">
  基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Vue
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/vue/v3/" class="nav-link">
  v3
</a></li><li class="dropdown-subitem"><a href="/frame/vue/v2/" class="nav-link">
  v2
</a></li><li class="dropdown-subitem"><a href="/frame/vue/vuex/" class="nav-link">
  Vuex
</a></li><li class="dropdown-subitem"><a href="/frame/vue/vue-router/" class="nav-link">
  VueRouter
</a></li></ul></li><li class="dropdown-item"><h4>
          React
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/react/react/" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/frame/react/react-router/" class="nav-link">
  ReactRouter
</a></li><li class="dropdown-subitem"><a href="/frame/react/redux/" class="nav-link">
  Redux
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="打包工具" class="dropdown-title"><span class="title">打包工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="打包工具" class="mobile-dropdown-title"><span class="title">打包工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Webpack
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/bundle-tool/webpack/v2.html" class="nav-link">
  v2
</a></li><li class="dropdown-subitem"><a href="/bundle-tool/webpack/v4.html" class="nav-link">
  v4
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/bundle-tool/rollup/" class="nav-link">
  Rollup
</a></li><li class="dropdown-item"><!----> <a href="/bundle-tool/gulp/" class="nav-link">
  Gulp
</a></li></ul></div></div><div class="nav-item"><a href="/share/" class="nav-link router-link-active">
  分享
</a></div><div class="nav-item"><a href="https://gitee.com/luguanrui/lgr-tools?_from=gitee_search" target="_blank" rel="noopener noreferrer" class="nav-link external">
  工具函数
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/luguanrui?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/base/" class="nav-link">
  基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="框架" class="mobile-dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Vue
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/vue/v3/" class="nav-link">
  v3
</a></li><li class="dropdown-subitem"><a href="/frame/vue/v2/" class="nav-link">
  v2
</a></li><li class="dropdown-subitem"><a href="/frame/vue/vuex/" class="nav-link">
  Vuex
</a></li><li class="dropdown-subitem"><a href="/frame/vue/vue-router/" class="nav-link">
  VueRouter
</a></li></ul></li><li class="dropdown-item"><h4>
          React
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/frame/react/react/" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/frame/react/react-router/" class="nav-link">
  ReactRouter
</a></li><li class="dropdown-subitem"><a href="/frame/react/redux/" class="nav-link">
  Redux
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="打包工具" class="dropdown-title"><span class="title">打包工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="打包工具" class="mobile-dropdown-title"><span class="title">打包工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Webpack
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/bundle-tool/webpack/v2.html" class="nav-link">
  v2
</a></li><li class="dropdown-subitem"><a href="/bundle-tool/webpack/v4.html" class="nav-link">
  v4
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/bundle-tool/rollup/" class="nav-link">
  Rollup
</a></li><li class="dropdown-item"><!----> <a href="/bundle-tool/gulp/" class="nav-link">
  Gulp
</a></li></ul></div></div><div class="nav-item"><a href="/share/" class="nav-link router-link-active">
  分享
</a></div><div class="nav-item"><a href="https://gitee.com/luguanrui/lgr-tools?_from=gitee_search" target="_blank" rel="noopener noreferrer" class="nav-link external">
  工具函数
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/luguanrui?tab=repositories" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>vue-lazyload源码阅读</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/share/vue-lazyload.html#为什么要读源码" class="sidebar-link">为什么要读源码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#准备工作" class="sidebar-link">准备工作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/share/vue-lazyload.html#_1-rollupjs" class="sidebar-link">1.Rollupjs</a></li><li class="sidebar-sub-header"><a href="/share/vue-lazyload.html#_2-vue插件" class="sidebar-link">2.Vue插件</a></li><li class="sidebar-sub-header"><a href="/share/vue-lazyload.html#_3-vue指令" class="sidebar-link">3.Vue指令</a></li><li class="sidebar-sub-header"><a href="/share/vue-lazyload.html#_4-全局组件" class="sidebar-link">4.全局组件</a></li><li class="sidebar-sub-header"><a href="/share/vue-lazyload.html#_5-图片懒加载的原理" class="sidebar-link">5.图片懒加载的原理</a></li></ul></li><li><a href="/share/vue-lazyload.html#如何调试源码" class="sidebar-link">如何调试源码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#目录结构" class="sidebar-link">目录结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#入口文件index" class="sidebar-link">入口文件index</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#lazy类" class="sidebar-link">Lazy类</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#reactivelistener类" class="sidebar-link">ReactiveListener类</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#lazycontainer类" class="sidebar-link">LazyContainer类</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#lazy-component组件" class="sidebar-link">lazy-component组件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#util工具函数" class="sidebar-link">util工具函数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/share/vue-lazyload.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-lazyload源码阅读"><a href="#vue-lazyload源码阅读" class="header-anchor">#</a> vue-lazyload源码阅读</h1> <h2 id="为什么要读源码"><a href="#为什么要读源码" class="header-anchor">#</a> 为什么要读源码</h2> <ol><li>项目中使用过，但是不是很明白它是怎么实现的</li></ol> <p>在开发项目过程中，经常会遇到一个问题，当一个页面中需要加载大量的图片，如果一次性加载完，会浪费网络资源不说，而且页面加载也会出现卡顿，用户体验非常的不好。因此，需要图片懒加载这种技术手段来处理这个问题，然而平时项目都比较赶，最快的方式就去找一个插件来使用。而我选择了<a href="https://github.com/hilongjw/vue-lazyload" target="_blank" rel="noopener noreferrer">vue-lazyload<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这款插件，主要原因是在github上star相对来说比较多。</p> <ol start="2"><li>为了不做一个拿来主义者，利用业余时间读下源码，给自己充充电</li></ol> <h2 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h2> <h3 id="_1-rollupjs"><a href="#_1-rollupjs" class="header-anchor">#</a> 1.Rollupjs</h3> <p><a href="https://www.rollupjs.com/" target="_blank" rel="noopener noreferrer">Rollupjs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是 JavaScript 模块打包器，配置非常的简单，<code>Vue</code>源代码也是使用<code>Rollupjs</code>打包的，非常有必要玩一下</p> <h3 id="_2-vue插件"><a href="#_2-vue插件" class="header-anchor">#</a> 2.Vue插件</h3> <p>自定义插件：</p> <div class="language-js extra-class"><pre class="language-js"><code>MyPlugin<span class="token punctuation">.</span><span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 添加全局方法或 property</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">myGlobalMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
  <span class="token comment">// 2. 添加全局指令（这里重点关注）</span>
  Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'my-directive'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指令第一次绑定到元素时调用，做初始化设置（只调用一次）</span>
    <span class="token function">bind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token comment">// 被绑定元素插入父节点时调用</span>
    <span class="token function">inserted</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 所在组件的 虚拟DOM 更新时调用(虚拟DOM更新前，生命周期为beforeUpdate())</span>
    <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 指令所在组件的 虚拟DOM 及其子 虚拟DOM 全部更新后调用（虚拟DOM更新前后,生命周期为updated()）</span>
    <span class="token function">componentUpdated</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 指令与元素解绑时调用（当前组件销毁 或者 指令绑定的元素存在v-if为false）（只调用一次）</span>
    <span class="token function">unbind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 3. 注入组件选项</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">created</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 4. 添加实例方法</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$myMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">methodOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
  <span class="token comment">// 5. 添加全局组件（这里重点关注）</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="custom-block details"><summary>指令钩子函数的参数</summary> <p>指令钩子函数的四个参数<code>el</code>，<code>binding</code>，<code>vnode</code>，<code>oldVnode</code>说明如下：</p> <ul><li>el：指令所绑定的DOM元素</li> <li>binding：一个对象，包含以下属性：
<ul><li>name：指令名，不包括 <code>v-</code> 前缀。</li> <li>value：指令的绑定值，例如<code>v-my-directive=&quot;1 + 1&quot;</code> 中，绑定值为 <code>2</code>。</li> <li>oldValue：指令绑定的前一个值，仅在 <code>update</code> 和 <code>componentUpdated</code> 钩子中可用</li> <li>expression：字符串形式的指令表达式。例如 <code>v-my-directive=&quot;1 + 1&quot;</code> 中，表达式为 <code>&quot;1 + 1&quot;</code>。</li> <li>arg：传给指令的参数，可选。例如 <code>v-my-directive:foo</code> 中，参数为 <code>&quot;foo</code>&quot;。</li> <li>modifiers：一个包含修饰符的对象。例如 <code>v-my-directive.foo.bar</code> 中，修饰符对象为 <code>{ foo: true, bar: true }</code></li></ul></li> <li>vnode：Vue 编译生成的虚拟节点</li> <li>oldVnode：上一个虚拟节点，仅在 update 和 componentUpdated 钩子中可用</li></ul></details> <p>注册自定义插件并传入参数：</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>MyPlugin<span class="token punctuation">,</span> <span class="token punctuation">{</span> someOption<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>官方文档入口<a href="https://cn.vuejs.org/v2/guide/plugins.html" target="_blank" rel="noopener noreferrer">Vue插件系统<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h3 id="_3-vue指令"><a href="#_3-vue指令" class="header-anchor">#</a> 3.Vue指令</h3> <p>注册全局指令<code>v-focus</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当被绑定的元素插入到 DOM 中时……</span>
  <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 聚焦元素</span>
    el<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>注册局部指令<code>v-focus</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>directives<span class="token operator">:</span> <span class="token punctuation">{</span>
  focus<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指令的定义</span>
    <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用指令：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-focus</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>以上官方提供的demo，具体可查询官方文档<a href="https://cn.vuejs.org/v2/guide/custom-directive.html" target="_blank" rel="noopener noreferrer">Vue自定义指令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h3 id="_4-全局组件"><a href="#_4-全局组件" class="header-anchor">#</a> 4.全局组件</h3> <p>注册全局组件：</p> <p>函数组件形式：</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'component-name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token string">''</span>
  <span class="token comment">// options</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以<code>.vue</code>模板的形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> ComponentA <span class="token keyword">from</span> <span class="token string">'@/components/ComponentA'</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'component-name'</span><span class="token punctuation">,</span> ComponentA<span class="token punctuation">)</span>
</code></pre></div><h3 id="_5-图片懒加载的原理"><a href="#_5-图片懒加载的原理" class="header-anchor">#</a> 5.图片懒加载的原理</h3> <p>懒加载的应用场景：当图片出现在视口中时，再加载图片</p> <p>实现步骤：</p> <ol><li>先将图片的<code>url</code>存放到<code>data-src</code>自定义属性（可随便设置）中（通过<code>el.dataset.src</code>来获取该属性的值）</li> <li>实例化<code>Image</code>对象得到缓存对象<code>cacheImg</code></li> <li>判断图片是否出现在视口中<code>checkInView</code></li> <li>如果图片出现在视口中，将图片的<code>data-src</code>赋值给<code>cacheImg</code>的<code>src</code>，加载图片</li> <li>通过事件<code>onload</code>，判断图片加载成功，如果是，则将<code>cacheImg</code>的<code>src</code>赋值给图片的<code>src</code></li> <li>通过事件<code>onerror</code>，判断图片失败，这时，将<code>error</code>图片的url赋值给图片的<code>src</code></li></ol> <p>简单实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">preloadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取img dom的集合 imgList</span>
  <span class="token keyword">const</span> imgList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
  <span class="token comment">// 遍历 imgList</span>
  imgList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例化Image对象</span>
    <span class="token keyword">let</span> cacheImg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 检查图片是否出现在视口中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkInView</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 将 data-src 中的值赋值给 cacheImg 的 src，此时会加载图片</span>
      cacheImg<span class="token punctuation">.</span>src <span class="token operator">=</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src
      <span class="token comment">// 图片加载完成</span>
      cacheImg<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将 img.src 设置给对应的 el src</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span> cacheImg<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 图片加载失败</span>
      img<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置 error 图片</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span> <span class="token string">'./error.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如何判断图片是否出现在视口中：</p> <ul><li>第一种方式：通过监听<code>scroll</code>等事件，调用目标元素的<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect" target="_blank" rel="noopener noreferrer">getBoundingClientRect()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>方法，得到它相对于视口的坐标，即可判断是否出现在视口中</li></ul> <p>getBoundingClientRect的图解：</p> <p><img src="/assets/img/getBoundingClientRect.909635c6.png" alt=""></p> <p>实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">checkInView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rect <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 获取当前dom元素的大小及其相对于视口的位置</span>
  <span class="token keyword">const</span> height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight <span class="token comment">// 视口高度</span>
  <span class="token keyword">const</span> width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth  <span class="token comment">// 视口宽度</span>
  <span class="token keyword">const</span> yInView <span class="token operator">=</span> rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> height <span class="token operator">&amp;&amp;</span> rect<span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token comment">// 纵向出现在视口中</span>
  <span class="token keyword">const</span> xInView <span class="token operator">=</span> rect<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> width <span class="token operator">&amp;&amp;</span> rect<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token comment">// 横向出现在视口中</span>
  <span class="token keyword">return</span> yInView <span class="token operator">&amp;&amp;</span> xInView
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>第二种方式：浏览器自带的 交叉观察器 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API" target="_blank" rel="noopener noreferrer">IntersectionObserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> api</li></ul> <p>简单实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">createObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 定义参数</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    root<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 视口,默认是 null,即document对象</span>
    rootMargin<span class="token operator">:</span> <span class="token string">'0px'</span><span class="token punctuation">,</span> <span class="token comment">// 围绕视口的边距</span>
    threshold<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 阈值，数组或者数字，表示在目标元素在视口中出现的百分比是多少时，再去触发回调函数</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
    * 2. 定义会调用回调函数，目标元素与视口相交时会调用该回调函数
    * @param {*} entries IntersectionObserverEntry的集合
    * @param {*} observer IntersectionObserver的实例
    */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">entries<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(entries, 'entries')</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用observe方法的时，会触发一次回调函数，因此需要判断是否交叉</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// entry.target 被观察的DOM元素</span>
        <span class="token comment">// observe === observer</span>
        <span class="token comment">// observe.unobserve(document.getElementById('element'))</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// console.log(observe === observer)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
    * 3. 创建观察器实例，异步观察目标元素与视口相交的变化
    * @param {*} callback 目标元素的可见性变化时,调用的回调函数
    * @param {*} options 参数
    */</span>
  <span class="token keyword">const</span> observe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

  <span class="token comment">// 4. 指定 DOM节点 开始观察</span>
  observe<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'element'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 取消指定 DOM节点 的观察</span>
  <span class="token comment">// observe.unobserve(document.getElementById('element'))</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="如何调试源码"><a href="#如何调试源码" class="header-anchor">#</a> 如何调试源码</h2> <ol><li>首先从<code>github</code>上将<a href="https://github.com/hilongjw/vue-lazyload" target="_blank" rel="noopener noreferrer">vue-lazyload<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>源码<code>clone</code>下来</li> <li>创建一个<code>Vue</code>项目,这里我使用<a href="https://cli.vuejs.org/" target="_blank" rel="noopener noreferrer">Vue CLI<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>脚手架创建</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>vue create lazy
<span class="token builtin class-name">cd</span> lazy
<span class="token function">yarn</span> serve
</code></pre></div><ol start="3"><li>将<code>vue-lazyload</code>源码中的<code>src</code>目录copy到上面创建的项目中，并<code>src</code>目录改名为<code>vue-lazyload</code>(可以自己随便定义)</li> <li>在<code>main.js</code>文件引入，并注册插件</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> Lazyload <span class="token keyword">from</span> <span class="token string">'./vue-lazyload'</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Lazyload<span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">警告</p> <p>由于<code>vue-lazyload</code>项目中引入插件<code>assign-deep</code>,所以需要先手动安装下这个插件, 执行命令<code>yarn install assign-deep</code>即可</p></div> <ol start="5"><li>以上步骤完成之后，就可以启动自己的项目，随便的调试源码了</li></ol> <p>至此，准备工作已经完全做完，下面正式开始解读源码！</p> <h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>├── src
│   ├── index.js
│   ├── lazy-component.js
│   ├── lazy-container.js
│   ├── lazy-image.js
│   ├── lazy.js
│   ├── listener.js
│   └── util.js
</code></pre></div><p>目录解读：</p> <ul><li>index.js：入口文件</li> <li>lazy-component.js：懒加载组件</li> <li>lazy-container.js：懒加载容器</li> <li>lazy-image.js：官方文档中尚未列出参数<code>lazyImage</code>,暂不分析</li> <li>lazy.js：懒加载类</li> <li>listener.js：监听类</li> <li>util.js：工具函数</li></ul> <h2 id="入口文件index"><a href="#入口文件index" class="header-anchor">#</a> 入口文件index</h2> <p>首先从入口文件<code>index.js</code>开始下手, 其中包含了一些<code>vue1.0</code>版本相关的兼容性代码，<code>vue3.0</code>即将在8月份来临，还有人在用<code>vue1.0</code>？因此，注释掉<code>vue1.0</code>相关的兼容性代码，代码结构也会显得更加的简单明了。</p> <p>源码解析如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Lazy <span class="token keyword">from</span> <span class="token string">'./lazy'</span>
<span class="token keyword">import</span> LazyComponent <span class="token keyword">from</span> <span class="token string">'./lazy-component'</span>
<span class="token keyword">import</span> LazyContainer <span class="token keyword">from</span> <span class="token string">'./lazy-container'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// 插件提供install方法用于注册，传入两个参数，分别为`Vue`, `options`(自定义参数)</span>
  <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行`Lazy`函数，传入参数`Vue`，返回`LazyClass`类</span>
    <span class="token keyword">const</span> LazyClass <span class="token operator">=</span> <span class="token function">Lazy</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
    <span class="token comment">// 实例化`LazyClass`类，传入自定义参数`options`, 得到实例`lazy`</span>
    <span class="token keyword">const</span> lazy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyClass</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    
    <span class="token comment">// 实例化`LazyContainer`，并传入实例`{ lazy }`，得到实例`lazyContainer`</span>
    <span class="token keyword">const</span> lazyContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyContainer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> lazy <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 将实例`lazy`挂载到`Vue`的原型属性`$Lazyload`上</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$Lazyload <span class="token operator">=</span> lazy

    <span class="token comment">// 注册组件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>lazyComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行 LazyComponent()，传入 `lazy`实例，返回一个Vue组件</span>
      Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'lazy-component'</span><span class="token punctuation">,</span> <span class="token function">LazyComponent</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 注册全局指令`v-lazy`</span>
    Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'lazy'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 指令第一次绑定到元素时，执行 lazy.add()</span>
      bind<span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 所在组件的 虚拟DOM 更新时，执行初始化，执行 lazy.update()</span>
      update<span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 指令所在的 虚拟DOM 及 其子虚拟DOM 全部更新后，执行 lazy.lazyLoadHandler()</span>
      componentUpdated<span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">,</span> 
      <span class="token comment">// 指令与元素解绑时, 执行 lazy.remove()</span>
      unbind<span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 注册全局指令`v-lazy-container`</span>
    Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'lazy-container'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      bind<span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// lazyContainer.bind()</span>
      componentUpdated<span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// lazyContainer.update</span>
      unbind<span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span> <span class="token comment">// lazyContainer.unbind</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从上面的分析，可以看出来，入口文件做了如下几件事：</p> <ul><li>提供了注册插件的入口<code>install</code></li> <li>在注册插件的同时，注册了 <code>lazy-component</code>全局组件</li> <li>在注册插件的同时，注册了 <code>v-lazy</code>, <code>v-lazy-container</code> 全局指令</li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <ol><li>以上定义的钩子函数都带有一个<code>bind</code>，是为了使得函数中的<code>this</code>指向<code>Lazy</code>类或<code>LazyContainerMananger</code>类，若不绑定 <code>this</code> 会指向 <code>undefined</code></li> <li>不可以使用<code>call</code>或者<code>apply</code>，因为会立即执相应的函数</li></ol></div> <p>当我们使用<code>v-lazy</code>指令的时候，也就是指令<code>v-lazy</code>第一次绑定到元素时，会触发<code>bind</code>钩子函数，也就是<code>lazy.add()</code>方法，而这个方法是定义在<code>Lazy</code>类当中的，因此接下来，分析下<code>Lazy</code>类的实现</p> <h2 id="lazy类"><a href="#lazy类" class="header-anchor">#</a> Lazy类</h2> <p>功能：懒加载的主要功能都在这个类中实现</p> <p>由于<code>lazy.js</code>文件中的代码较多，为了有一个全局观，先看下<code>Lazy</code>类的大致结构,如下所示为简化后的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token comment">/* 一系列的工具方法，下面会介绍到 */</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./util&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 监听器，这个是vue-lazyload的核心，后面在去理解</span>
<span class="token keyword">import</span> ReactiveListener <span class="token keyword">from</span> <span class="token string">&quot;./listener&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Lazy</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>preLoad<span class="token punctuation">,</span> error<span class="token punctuation">,</span>throttleWait<span class="token punctuation">,</span><span class="token comment">/* ...插件支持的用户入参 */</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 监听队列，用来存放监听器</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>TargetIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>TargetQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
        silent<span class="token operator">:</span> silent<span class="token punctuation">,</span> 
        dispatchEvent<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>dispatchEvent<span class="token punctuation">,</span>
        throttleWait<span class="token operator">:</span> throttleWait <span class="token operator">||</span> <span class="token number">200</span><span class="token punctuation">,</span> 
        <span class="token comment">// ...还有很多的参数属性</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span> max<span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lazyLoadHandler <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_lazyLoadHandler</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>throttleWait
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>observer <span class="token operator">?</span> modeType<span class="token punctuation">.</span>observer <span class="token operator">:</span> modeType<span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">addLazyBox</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****bind钩子函数</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****update钩子函数</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****unbind钩子函数</span>
    <span class="token function">removeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">setMode</span><span class="token punctuation">(</span><span class="token parameter">mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_addListenerTarget</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_removeListenerTarget</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_initListen</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> start</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****componentUpdated钩子函数</span>
    <span class="token function">_initIntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_observerHandler</span><span class="token punctuation">(</span><span class="token parameter">entries<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_elRenderer</span><span class="token punctuation">(</span><span class="token parameter">listener<span class="token punctuation">,</span> state<span class="token punctuation">,</span> cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_valueFormatter</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>add()</code>方法实现的大致流程：</p> <p><img src="/assets/img/add.18f51115.png" alt=""></p> <p>可以看出，插件内部维护了一个监听队列<code>ListenerQueue</code>，来存储监听器 <code>listener</code>对象，通过遍历监听队列<code>ListenerQueue</code>，最终实现每张图片的懒加载</p> <p><code>add()</code>方法的源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过 DOM元素 判断监听器是否已存在于监听队列中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已存在，则调用更新方法 update</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在下一次DOM更新循环之后，执行lazyLoadHandler</span>
    <span class="token keyword">return</span> Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazyLoadHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据binding.value，获取图片的真实src, loading, error</span>
  <span class="token comment">// cors获取不到，因为_valueFormatter没有返回cors</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error<span class="token punctuation">,</span> cors <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_valueFormatter</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 由于这个时候DOM还没有渲染完成，需要做一些dom的操作，必须在nextTick中完成</span>
  Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//  如果el不是img标签 或者 该dom不包含属性data-srcset使用src</span>
    src <span class="token operator">=</span> <span class="token function">getBestSelectionFromSrcset</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>scale<span class="token punctuation">)</span> <span class="token operator">||</span> src<span class="token punctuation">;</span>

    <span class="token comment">// 使用交叉观察者模式观察dom元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observer <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取修饰符</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义父级dom元素</span>
    <span class="token keyword">let</span> $parent<span class="token punctuation">;</span>
    <span class="token comment">// 如果修饰符存在 ???</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $parent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">.</span>$refs<span class="token punctuation">[</span>container<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// if there is container passed in, try ref first, then fallback to getElementById to support the original usage</span>
      $parent <span class="token operator">=</span> $parent
        <span class="token operator">?</span> $parent<span class="token punctuation">.</span>$el <span class="token operator">||</span> $parent
        <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回window对象</span>
      $parent <span class="token operator">=</span> <span class="token function">scrollParent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> newListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveListener</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// bindType，传给指令的参数,例如 v-lazy:background-image=&quot;imgUrl&quot; 中，参数为 &quot;background-image&quot;</span>
      <span class="token comment">// 目前就是css的background-image属性</span>
      bindType<span class="token operator">:</span> binding<span class="token punctuation">.</span>arg<span class="token punctuation">,</span> 
      $parent<span class="token punctuation">,</span> <span class="token comment">// 父级dom元素</span>
      el<span class="token punctuation">,</span> <span class="token comment">// 当前dom元素</span>
      loading<span class="token punctuation">,</span> <span class="token comment">// 图片loading地址</span>
      error<span class="token punctuation">,</span> <span class="token comment">// 图片error地址</span>
      src<span class="token punctuation">,</span> <span class="token comment">// 图片真实src地址</span>
      cors<span class="token punctuation">,</span> <span class="token comment">// 这是获取不到的</span>
      elRenderer<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_elRenderer</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 实例化ReactiveListener的时候会执行，传入参数 &quot;loading&quot;, false</span>
      options<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token comment">// 参数</span>
      imageCache<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache<span class="token punctuation">,</span> <span class="token comment">// 图片缓存实例</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ListenerQueue 添加 listener</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newListener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TargetQueue 添加 target，</span>
      <span class="token comment">// 为DOM元素（el）遍历监听事件，添加事件监听，el分别设置为：window，$parent</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addListenerTarget</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addListenerTarget</span><span class="token punctuation">(</span>$parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行懒加载</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 有无必要在嵌套一个异步更新DOM???</span>
    Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">疑问</p> <p>有必要在<code>Vue.nextTick</code>中再次去调用一次<code>Vue.nextTick(() =&gt; this.lazyLoadHandler());</code>？？？</p></div> <p>当虚拟dom更新时，会调用<code>lazy.update</code>方法，<code>update()</code>方法的实现的大致流程：</p> <p><img src="/assets/img/update.f11f3fb5.png" alt=""></p> <p><code>update()</code>的实现源码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_valueFormatter</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  src <span class="token operator">=</span> <span class="token function">getBestSelectionFromSrcset</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>scale<span class="token punctuation">)</span> <span class="token operator">||</span> src<span class="token punctuation">;</span>

  <span class="token comment">// 查询监听队列中图片监听器是否已存在</span>
  <span class="token keyword">const</span> exist <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不存在则调用 add方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已存在，则调用图片监听器的update方法，替换图片的src</span>
    exist<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      src<span class="token punctuation">,</span>
      loading<span class="token punctuation">,</span>
      error<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果是使用 IntersectionObserver api，则先取消观察，在重新观察</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">疑问</p> <p>在指令钩子函数<code>componentUpdated</code>已经调用了一次<code>lazyLoadHandler</code>，是否有必要再次调用一次<code>Vue.nextTick(() =&gt; this.lazyLoadHandler());</code>？？？</p></div> <p>当指令与元素解绑时，调用<code>lazy.remove</code>方法，<code>remove()</code>方法的大致实现流程图：</p> <p><img src="/assets/img/remove.9807bb0e.png" alt=""></p> <p><code>remove()</code>的源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_observer <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> existItem <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为什么要执行两次，因为add()方法中_addListenerTarget执行了两次，分别传入window，$parent</span>
    <span class="token comment">// 删除 TargetQueue 中指定的el</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeListenerTarget</span><span class="token punctuation">(</span>existItem<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除 TargetQueue 中指定的el</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeListenerTarget</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除 ListenerQueue 中指定的 listener</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> existItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化这部分数据</span>
    existItem<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="reactivelistener类"><a href="#reactivelistener类" class="header-anchor">#</a> ReactiveListener类</h2> <p>主要是维护<code>ReactiveListener</code>类</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> loadImageAsync<span class="token punctuation">,</span> ObjectKeys<span class="token punctuation">,</span> noop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./util&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveListener</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token punctuation">,</span> <span class="token comment">// 当前dom元素</span>
    src<span class="token punctuation">,</span> <span class="token comment">// 图片的真实url</span>
    error<span class="token punctuation">,</span> <span class="token comment">// 图片加载错误的url</span>
    loading<span class="token punctuation">,</span> <span class="token comment">// 图片加载中的url</span>
    bindType<span class="token punctuation">,</span> <span class="token comment">// css属性</span>
    $parent<span class="token punctuation">,</span> <span class="token comment">// 父元素</span>
    options<span class="token punctuation">,</span> <span class="token comment">// 参数</span>
    cors<span class="token punctuation">,</span> <span class="token comment">// 跨域</span>
    elRenderer<span class="token punctuation">,</span> <span class="token comment">// dom元素渲染</span>
    imageCache<span class="token punctuation">,</span> <span class="token comment">// 图片缓存</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> el<span class="token punctuation">;</span> <span class="token comment">// 当前dom元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span> <span class="token comment">// 图片的真实 url</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span> <span class="token comment">// 图片加载错误的 url</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> loading<span class="token punctuation">;</span> <span class="token comment">// 图片加载中的 url</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bindType <span class="token operator">=</span> bindType<span class="token punctuation">;</span> <span class="token comment">// css属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 尝试加载次数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cors <span class="token operator">=</span> cors<span class="token punctuation">;</span> <span class="token comment">// 跨域</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>naturalHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 真实高度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>naturalWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 真实宽度</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span> <span class="token comment">// 参数</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>rect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// getBoundingClientRect 对象</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">=</span> $parent<span class="token punctuation">;</span> <span class="token comment">// 父元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>elRenderer <span class="token operator">=</span> elRenderer<span class="token punctuation">;</span> <span class="token comment">// dom元素渲染</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache <span class="token operator">=</span> imageCache<span class="token punctuation">;</span> <span class="token comment">// 图片缓存</span>

    <span class="token comment">// 性能</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>performanceData <span class="token operator">=</span> <span class="token punctuation">{</span>
      init<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      loadStart<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      loadEnd<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过自定义方法，动态修改图片的src</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化状态</span>
    <span class="token comment">// 将图片的url设置到data-src，初始化state的loading，error，loaded，rendered都为false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化渲染，传入图片加载状态loading，缓存状态false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loading&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 初始化状态
   * init listener state
   * 作用：
   * 1. 将图片的url设置到自定义的 data-src 属性上
   * 2. 初始化 this.state 对象，loading，error，loaded，rendered
   */</span>
  <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置 data-src</span>
    <span class="token comment">// 处理dataset的兼容性问题，https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/dataset</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;dataset&quot;</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过in方法，判断 dataset属性 是否 存在与DOM对象上</span>
      <span class="token comment">// 通过 dataset 设置自定义属性 data-src</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过 setAttribute 设置自定义属性 data-src</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;data-src&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      error<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      rendered<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 记录执行时间
   * record performance
   * @return
   */</span>
  <span class="token function">record</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>performanceData<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 如果老的图片url 不等于 新的url，则，初始化initState，src为新的url
   * update image listener data
   * @param  {String} image uri
   * @param  {String} loading image uri
   * @param  {String} error image uri
   * @return
   */</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> src<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldSrc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> loading<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
    <span class="token comment">// 通过自定义方法，动态修改图片的src</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldSrc <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * get el node rect
   * @return
   */</span>
  <span class="token function">getRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 当前元素是否出现在视口中, true-是，false-否
   *  check el is in view
   * @return {Boolean} el is in view
   */</span>
  <span class="token function">checkInView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoadTop <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 通过自定义方法，动态修改图片的src
   * listener filter
   */</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ObjectKeys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行过滤函数</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>filter<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 渲染loading
   * render loading first
   * @params cb:Function
   * @return
   */</span>
  <span class="token function">renderLoading</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 图片的loading状态更改为true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// 异步渲染图片</span>
    <span class="token function">loadImageAsync</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        src<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loading<span class="token punctuation">,</span>
        cors<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cors<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loading&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 图片的loading状态更改为false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// handler `loading image` load failed</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 图片的loading状态更改为false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>silent<span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VueLazyload log: load failed with loading image(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>loading<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 加载图片，并渲染出来
   * try load image and  render it
   * @return
   */</span>
  <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">onFinish <span class="token operator">=</span> noop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 尝试加载次数大于自定义的尝试加载次数，并his.state.error</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>attempt <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>silent<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VueLazyload log: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> tried too more than </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>attempt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 图片已加载并渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>rendered <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// 图片已缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 加载图片</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loaded&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>rendered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 渲染图片</span>
      <span class="token keyword">return</span> <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 渲染加载中的状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderLoading</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>attempt<span class="token operator">++</span><span class="token punctuation">;</span>

      <span class="token comment">// 在图片beforeLoad阶段做自定义的事情</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>adapter<span class="token punctuation">[</span><span class="token string">&quot;beforeLoad&quot;</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>adapter<span class="token punctuation">[</span><span class="token string">&quot;beforeLoad&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 性能测试-loadStart</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string">&quot;loadStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">loadImageAsync</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          src<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">,</span>
          cors<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cors<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>naturalHeight <span class="token operator">=</span> data<span class="token punctuation">.</span>naturalHeight<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>naturalWidth <span class="token operator">=</span> data<span class="token punctuation">.</span>naturalWidth<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 图片的loaded状态更改为true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 图片的error状态更改为false</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string">&quot;loadEnd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 性能测试-loadEnd</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loaded&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>rendered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 图片的rendered状态更改为true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将图片url缓存</span>
          <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 图片加载出错</span>
          <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>silent <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 图片的error状态更改为true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 图片的loaded状态更改为false</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 渲染图片
   * render image
   * @param  {String} state to render // ['loading', 'src', 'error']
   * @param  {String} is form cache
   * @return
   */</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">elRenderer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 性能测试
   * output performance data
   * @return {Object} performance data
   */</span>
  <span class="token function">performance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token string">&quot;loading&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state <span class="token operator">=</span> <span class="token string">&quot;loaded&quot;</span><span class="token punctuation">;</span>
      time <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>performanceData<span class="token punctuation">.</span>loadEnd <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>performanceData<span class="token punctuation">.</span>loadStart<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">)</span> state <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      src<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">,</span>
      state<span class="token punctuation">,</span>
      time<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 销毁
   * $destroy
   * @return
   */</span>
  <span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bindType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="lazycontainer类"><a href="#lazycontainer类" class="header-anchor">#</a> LazyContainer类</h2> <p>全局指令<code>v-lazy-container</code>，定义：</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'lazy-container'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  bind<span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  componentUpdated<span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  unbind<span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>功能：当图片出现在视口中时，再去加载图片</p> <p>使用的方式：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-lazy-container</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ selector: <span class="token punctuation">'</span>img<span class="token punctuation">'</span>, error: <span class="token punctuation">'</span>xxx.jpg<span class="token punctuation">'</span>, loading: <span class="token punctuation">'</span>xxx.jpg<span class="token punctuation">'</span> }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img1.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img2.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img3.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

或者

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-lazy-container</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ selector: <span class="token punctuation">'</span>img<span class="token punctuation">'</span> }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img1.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-error</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img2.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img3.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>lazy-container.js</code>源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  find<span class="token punctuation">,</span>
  remove<span class="token punctuation">,</span>
  assign<span class="token punctuation">,</span>
  ArrayFrom
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span>

<span class="token comment">// 定义一个 LazyContainerMananger类</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">LazyContainerMananger</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接受实例化之后的lazy类</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> lazy <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> lazy
    lazy<span class="token punctuation">.</span>lazyContainerMananger <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 定义队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 指令第一绑定时</span>
  <span class="token function">bind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例化 LazyContainer</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyContainer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> lazy<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 将实例化之后的LazyContainer存储到队列_queue中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 虚拟dom更新时，查询到队列 _queue 中需要更新的 container，调用update方法</span>
  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">)</span> <span class="token keyword">return</span>
    container<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 查询队列中需要解绑的 container，调用clear方法，然后在将该container从队列中移除</span>
  <span class="token function">unbind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">)</span> <span class="token keyword">return</span>
    container<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 默认选择img标签</span>
<span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'img'</span>
<span class="token punctuation">}</span>
<span class="token comment">// 定义 LazyContainer类</span>
<span class="token keyword">class</span> <span class="token class-name">LazyContainer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> lazy <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 默认 el为 null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vnode <span class="token operator">=</span> vnode <span class="token comment">// 获取指令钩子函数的参数 虚拟DOM</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>binding <span class="token operator">=</span> binding <span class="token comment">// 获取指令钩子函数的参数 binding</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 定义参数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> lazy <span class="token comment">// 获取实例化的lazy类</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 定义队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 更新</span>
  <span class="token punctuation">}</span>

  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> el
    <span class="token comment">// 合并参数 defaultOptions，binding.value </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaultOptions<span class="token punctuation">,</span> binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token comment">// 获取img DOM对象的集合</span>
    <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getImgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历imgDOM对象的集合</span>
    imgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用lazy类的add()方法，传入参数el、合并 this.binding与自定义的value、虚拟DOM</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>binding<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        value<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// 需要设置 data-src为 img的url</span>
          src<span class="token operator">:</span> <span class="token string">'dataset'</span> <span class="token keyword">in</span> el <span class="token operator">?</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src <span class="token operator">:</span> el<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// 使用data-error属性为每个元素设置error图片，获取使用全局的 error 参数</span>
          error<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">'dataset'</span> <span class="token keyword">in</span> el <span class="token operator">?</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>error <span class="token operator">:</span> el<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>error<span class="token punctuation">,</span>
          <span class="token comment">// 使用data-loading属性为每个元素设置loading图片，获取使用全局的 loading 参数</span>
          loading<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">'dataset'</span> <span class="token keyword">in</span> el <span class="token operator">?</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>loading <span class="token operator">:</span> el<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-loading'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>loading
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将选择器获得的 全部img DOM对象类数组 转化为 数组</span>
  <span class="token function">getImgs</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">ArrayFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 清除</span>
  <span class="token function">clear</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getImgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 调用lazy的remove方法清除</span>
    imgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>vnode <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>binding <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="lazy-component组件"><a href="#lazy-component组件" class="header-anchor">#</a> lazy-component组件</h2> <p>全局组件<code>lazy-component</code>，该组件是一个<code>函数组件</code>，是为了要将<code>lazy</code>作为参数传递</p> <p><code>lazy-component.js</code>源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> inBrowser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">lazy</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
      tag<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'div'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 使用插槽 this.$slots.default</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>show <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        state<span class="token operator">:</span> <span class="token punctuation">{</span>
          loaded<span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        rect<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        show<span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token comment">// 获取当前dom对象</span>
      lazy<span class="token punctuation">.</span><span class="token function">addLazyBox</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 将 vm 添加到 ListenerQueue 中，添加事件</span>
      <span class="token comment">// 执行懒加载，此时this指向当前组件，会调用组件中定义的getRect，checkInView，load，destroy方法</span>
      lazy<span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">beforeDestroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将该 vm 从队列 ListenerQueue 中移除，移除事件</span>
      lazy<span class="token punctuation">.</span><span class="token function">removeComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前组件对象</span>
      <span class="token function">getRect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">checkInView</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inBrowser <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> lazy<span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">*</span> lazy<span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">load</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>show <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token comment">// 提供事件 show，参数为当前组件对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'show'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">destroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$destroy
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">提示</p> <p>使用该组件，如果容器中没有其他的DOM元素，rect对象的top，bottom，left，right都是0，则不会执行load方法，即不会渲染图片</p></div> <h2 id="util工具函数"><a href="#util工具函数" class="header-anchor">#</a> util工具函数</h2> <p><code>util.js</code>工具函数库，包括如下工具函数：</p> <ul><li>ImageCache：定义ImageCache类用来存储图片，包括has，add，free方法</li> <li>inBrowser：判断window是否存在</li> <li>CustomEvent：自定义事件对象CustomEvent</li> <li>remove：删除数组中的指定元素</li> <li>some：判断数组中是否存在某个函数</li> <li>find：查询数组中的某个函数</li> <li>assign：深度合并对象，使用<code>assign-deep</code></li> <li>noop：空函数</li> <li>ArrayFrom： 将类数组转化数组</li> <li>_：添加自定义事件，移除自定义事件</li> <li>isObject：是否是对象</li> <li>throttle：节流函数</li> <li>supportWebp：是否支持Webp</li> <li>getDPR：获取独立像素比/分辨率，devicePixelRatio</li> <li>scrollParent： 返回window对象</li> <li>loadImageAsync：异步加载图片</li> <li>getBestSelectionFromSrcset：根据独立像素比，设置不同的图片</li> <li>ObjectKeys：获取对象的keys</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>通过阅读<code>vue-lazyload</code>源码，收获如下：</p> <ul><li><code>Vue</code>自定义插件（包括自定义组件，自定义指令）</li> <li>对图片懒加载的实现有了全新的认识</li></ul> <p><code>vue-lazyload</code>通过会维护一个<code>ListenerQueue</code>队列来实现图片的懒加载，代码执行主流程如下：</p> <p><img src="/assets/img/main.9d3c0658.png" alt=""></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-05-20 16:25:56</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a68e905e.js" defer></script><script src="/assets/js/2.545454b5.js" defer></script><script src="/assets/js/4.dda20d7b.js" defer></script>
  </body>
</html>
