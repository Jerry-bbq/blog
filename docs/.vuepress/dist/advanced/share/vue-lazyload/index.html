<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/logo.png"><title>vue-lazyload源码阅读 | Blog</title><meta name="description" content="技术博客">
    <link rel="modulepreload" href="/blog/assets/app.5bb0e60c.js"><link rel="modulepreload" href="/blog/assets/index.html.e4251081.js"><link rel="modulepreload" href="/blog/assets/index.html.501a197d.js"><link rel="prefetch" href="/blog/assets/index.html.cd27c790.js"><link rel="prefetch" href="/blog/assets/index.html.2b06f684.js"><link rel="prefetch" href="/blog/assets/babel.html.fe2fe1a3.js"><link rel="prefetch" href="/blog/assets/index.html.c65c5077.js"><link rel="prefetch" href="/blog/assets/summary.html.d3cc4b1a.js"><link rel="prefetch" href="/blog/assets/index.html.9e3e7c00.js"><link rel="prefetch" href="/blog/assets/index.html.05b03818.js"><link rel="prefetch" href="/blog/assets/binary-search.html.0ea4da02.js"><link rel="prefetch" href="/blog/assets/complexity.html.18b5a747.js"><link rel="prefetch" href="/blog/assets/dfs-bfs.html.57a63026.js"><link rel="prefetch" href="/blog/assets/recursion.html.08b906ee.js"><link rel="prefetch" href="/blog/assets/sort.html.f5c1ab78.js"><link rel="prefetch" href="/blog/assets/index.html.1edb8b99.js"><link rel="prefetch" href="/blog/assets/algorithm-complexity.html.df5188b9.js"><link rel="prefetch" href="/blog/assets/algorithm-skill.html.62d35f21.js"><link rel="prefetch" href="/blog/assets/array.html.8f7ee702.js"><link rel="prefetch" href="/blog/assets/avl-tree.html.490a78b1.js"><link rel="prefetch" href="/blog/assets/bst.html.c553209c.js"><link rel="prefetch" href="/blog/assets/circular-linked-list.html.6061ac5b.js"><link rel="prefetch" href="/blog/assets/dictionary.html.f549819f.js"><link rel="prefetch" href="/blog/assets/doubly-linked-list.html.b9d8e742.js"><link rel="prefetch" href="/blog/assets/graph.html.75893d2e.js"><link rel="prefetch" href="/blog/assets/linked-list.html.e944292d.js"><link rel="prefetch" href="/blog/assets/minHeap.html.91b4338e.js"><link rel="prefetch" href="/blog/assets/queue.html.9fc24fb5.js"><link rel="prefetch" href="/blog/assets/recursive.html.92254066.js"><link rel="prefetch" href="/blog/assets/red-black-tree.html.08d5b0b7.js"><link rel="prefetch" href="/blog/assets/set.html.0e95c8a1.js"><link rel="prefetch" href="/blog/assets/sort-and-search.html.c3a87bc5.js"><link rel="prefetch" href="/blog/assets/sorted-linked-list.html.dafa8028.js"><link rel="prefetch" href="/blog/assets/stack-linked-list.html.7985d280.js"><link rel="prefetch" href="/blog/assets/stack.html.7a5ec565.js"><link rel="prefetch" href="/blog/assets/index.html.96c37052.js"><link rel="prefetch" href="/blog/assets/index.html.8153ec54.js"><link rel="prefetch" href="/blog/assets/index.html.8d56e3e9.js"><link rel="prefetch" href="/blog/assets/gauge.html.e1dad6fb.js"><link rel="prefetch" href="/blog/assets/hexo.html.b011ff23.js"><link rel="prefetch" href="/blog/assets/tool-library.html.62153d18.js"><link rel="prefetch" href="/blog/assets/v2.html.1c7eff29.js"><link rel="prefetch" href="/blog/assets/v4.html.95672b55.js"><link rel="prefetch" href="/blog/assets/v5.html.869d9e64.js"><link rel="prefetch" href="/blog/assets/index.html.2aed6aa2.js"><link rel="prefetch" href="/blog/assets/charles.html.4d0d1499.js"><link rel="prefetch" href="/blog/assets/git.html.a65170a5.js"><link rel="prefetch" href="/blog/assets/node-registry-manage.html.67968c8c.js"><link rel="prefetch" href="/blog/assets/node-version-manager.html.0022b3cc.js"><link rel="prefetch" href="/blog/assets/vue.html.e38ea0a9.js"><link rel="prefetch" href="/blog/assets/auto-deploy.html.f3dd0365.js"><link rel="prefetch" href="/blog/assets/download-by-url.html.14398ef7.js"><link rel="prefetch" href="/blog/assets/download.html.acf38336.js"><link rel="prefetch" href="/blog/assets/get-lastday.html.96dcb070.js"><link rel="prefetch" href="/blog/assets/parseInt.html.e7490a59.js"><link rel="prefetch" href="/blog/assets/scroll-into-view.html.d524275e.js"><link rel="prefetch" href="/blog/assets/tree-operate.html.24fb299d.js"><link rel="prefetch" href="/blog/assets/index.html.7594694d.js"><link rel="prefetch" href="/blog/assets/app.html.5dc54496.js"><link rel="prefetch" href="/blog/assets/index.html.fc6aa45c.js"><link rel="prefetch" href="/blog/assets/antd-vue-upload.html.213fb68a.js"><link rel="prefetch" href="/blog/assets/bind-string.html.9647e955.js"><link rel="prefetch" href="/blog/assets/component-loop.html.9916514d.js"><link rel="prefetch" href="/blog/assets/elementui-dialog.html.1444b442.js"><link rel="prefetch" href="/blog/assets/elementui-dynamic-table.html.a04a9beb.js"><link rel="prefetch" href="/blog/assets/elementui-table-auto-height.html.a78c1f96.js"><link rel="prefetch" href="/blog/assets/elementui-table-pagination.html.700e76f5.js"><link rel="prefetch" href="/blog/assets/fe-pagination.html.d67f9258.js"><link rel="prefetch" href="/blog/assets/gitlab.html.1f436243.js"><link rel="prefetch" href="/blog/assets/init-data.html.8844e5ea.js"><link rel="prefetch" href="/blog/assets/keep-alive.html.c3663190.js"><link rel="prefetch" href="/blog/assets/new-tab.html.358f4b2a.js"><link rel="prefetch" href="/blog/assets/vue-ie9.html.e00a0f5e.js"><link rel="prefetch" href="/blog/assets/vue-router-params.html.51d75b4a.js"><link rel="prefetch" href="/blog/assets/index.html.adf3ac57.js"><link rel="prefetch" href="/blog/assets/animation.html.4ed6458c.js"><link rel="prefetch" href="/blog/assets/bfc.html.4dfba76a.js"><link rel="prefetch" href="/blog/assets/box-model.html.07622946.js"><link rel="prefetch" href="/blog/assets/center.html.d536f390.js"><link rel="prefetch" href="/blog/assets/clear.html.498054da.js"><link rel="prefetch" href="/blog/assets/flex.html.f4130291.js"><link rel="prefetch" href="/blog/assets/layout.html.3699107e.js"><link rel="prefetch" href="/blog/assets/other.html.a8bc422d.js"><link rel="prefetch" href="/blog/assets/rem.html.c975220f.js"><link rel="prefetch" href="/blog/assets/canvas-svg.html.39a4f133.js"><link rel="prefetch" href="/blog/assets/doctype.html.94e7d434.js"><link rel="prefetch" href="/blog/assets/other.html.554b4af9.js"><link rel="prefetch" href="/blog/assets/painting.html.4e89e94d.js"><link rel="prefetch" href="/blog/assets/reflow-repaint.html.c2ebc309.js"><link rel="prefetch" href="/blog/assets/rendering-engine.html.99b0d899.js"><link rel="prefetch" href="/blog/assets/array.html.9258c3c7.js"><link rel="prefetch" href="/blog/assets/asyn-single-thread.html.930319a7.js"><link rel="prefetch" href="/blog/assets/coding.html.9eac36d0.js"><link rel="prefetch" href="/blog/assets/communications.html.426640e3.js"><link rel="prefetch" href="/blog/assets/data-type.html.abd886f3.js"><link rel="prefetch" href="/blog/assets/dom.html.e1da093f.js"><link rel="prefetch" href="/blog/assets/engineering.html.fe1b63d5.js"><link rel="prefetch" href="/blog/assets/error.html.e0af65b6.js"><link rel="prefetch" href="/blog/assets/es6.html.e1f5eabd.js"><link rel="prefetch" href="/blog/assets/gc.html.cd5f2a92.js"><link rel="prefetch" href="/blog/assets/http.html.8198af11.js"><link rel="prefetch" href="/blog/assets/object.html.2314eb5b.js"><link rel="prefetch" href="/blog/assets/page-performance.html.53d9f186.js"><link rel="prefetch" href="/blog/assets/prototype-chain.html.e464baf8.js"><link rel="prefetch" href="/blog/assets/safe.html.b143b8a1.js"><link rel="prefetch" href="/blog/assets/scope-closure.html.d318e721.js"><link rel="prefetch" href="/blog/assets/string.html.d10114ac.js"><link rel="prefetch" href="/blog/assets/index.html.e4659324.js"><link rel="prefetch" href="/blog/assets/index.html.40029cb9.js"><link rel="prefetch" href="/blog/assets/index.html.c1a2d083.js"><link rel="prefetch" href="/blog/assets/docker.html.f63f21b9.js"><link rel="prefetch" href="/blog/assets/nginx.html.09687ba8.js"><link rel="prefetch" href="/blog/assets/zentao.html.2bf79687.js"><link rel="prefetch" href="/blog/assets/index.html.4385bea6.js"><link rel="prefetch" href="/blog/assets/index.html.1cc32e92.js"><link rel="prefetch" href="/blog/assets/index.html.9c584ce7.js"><link rel="prefetch" href="/blog/assets/index.html.1a061454.js"><link rel="prefetch" href="/blog/assets/index.html.0c7cd841.js"><link rel="prefetch" href="/blog/assets/index.html.ef1b503b.js"><link rel="prefetch" href="/blog/assets/questions.html.f057105b.js"><link rel="prefetch" href="/blog/assets/reactive.html.1071e187.js"><link rel="prefetch" href="/blog/assets/render.html.e340a7be.js"><link rel="prefetch" href="/blog/assets/index.html.b46aec26.js"><link rel="prefetch" href="/blog/assets/index.html.8abe3986.js"><link rel="prefetch" href="/blog/assets/index.html.a1b72615.js"><link rel="prefetch" href="/blog/assets/index.html.3525d0cb.js"><link rel="prefetch" href="/blog/assets/arrow-func.html.9b99beb2.js"><link rel="prefetch" href="/blog/assets/promise.html.53c0cd5a.js"><link rel="prefetch" href="/blog/assets/Observer.html.5353a177.js"><link rel="prefetch" href="/blog/assets/def.html.fd6342b7.js"><link rel="prefetch" href="/blog/assets/defineProperty.html.71fdc0f4.js"><link rel="prefetch" href="/blog/assets/defineReactive.html.221fb315.js"><link rel="prefetch" href="/blog/assets/my-observe.html.426f146e.js"><link rel="prefetch" href="/blog/assets/observe.html.257fd616.js"><link rel="prefetch" href="/blog/assets/dep.html.6be40467.js"><link rel="prefetch" href="/blog/assets/watcher.html.c92d305a.js"><link rel="prefetch" href="/blog/assets/404.html.7d858b3d.js"><link rel="prefetch" href="/blog/assets/index.html.f2de9048.js"><link rel="prefetch" href="/blog/assets/index.html.ac1e6e3e.js"><link rel="prefetch" href="/blog/assets/babel.html.931615e2.js"><link rel="prefetch" href="/blog/assets/index.html.0975fe15.js"><link rel="prefetch" href="/blog/assets/summary.html.b4f58891.js"><link rel="prefetch" href="/blog/assets/index.html.c2980b00.js"><link rel="prefetch" href="/blog/assets/index.html.de9828fb.js"><link rel="prefetch" href="/blog/assets/binary-search.html.67305b63.js"><link rel="prefetch" href="/blog/assets/complexity.html.6f5e75ce.js"><link rel="prefetch" href="/blog/assets/dfs-bfs.html.d2c2b9eb.js"><link rel="prefetch" href="/blog/assets/recursion.html.e6fb4b82.js"><link rel="prefetch" href="/blog/assets/sort.html.d6bd69d6.js"><link rel="prefetch" href="/blog/assets/index.html.75a32572.js"><link rel="prefetch" href="/blog/assets/algorithm-complexity.html.e04ec169.js"><link rel="prefetch" href="/blog/assets/algorithm-skill.html.2609638b.js"><link rel="prefetch" href="/blog/assets/array.html.48d4db83.js"><link rel="prefetch" href="/blog/assets/avl-tree.html.86dfb4f8.js"><link rel="prefetch" href="/blog/assets/bst.html.915d8af1.js"><link rel="prefetch" href="/blog/assets/circular-linked-list.html.2e30c8ac.js"><link rel="prefetch" href="/blog/assets/dictionary.html.44fcdb64.js"><link rel="prefetch" href="/blog/assets/doubly-linked-list.html.f489552a.js"><link rel="prefetch" href="/blog/assets/graph.html.e4c5efc6.js"><link rel="prefetch" href="/blog/assets/linked-list.html.f7ec3641.js"><link rel="prefetch" href="/blog/assets/minHeap.html.90bf669d.js"><link rel="prefetch" href="/blog/assets/queue.html.d29990fa.js"><link rel="prefetch" href="/blog/assets/recursive.html.f5d4d8ca.js"><link rel="prefetch" href="/blog/assets/red-black-tree.html.d3eebacb.js"><link rel="prefetch" href="/blog/assets/set.html.b008e9d6.js"><link rel="prefetch" href="/blog/assets/sort-and-search.html.0791df9d.js"><link rel="prefetch" href="/blog/assets/sorted-linked-list.html.47ccd2e5.js"><link rel="prefetch" href="/blog/assets/stack-linked-list.html.9de86706.js"><link rel="prefetch" href="/blog/assets/stack.html.7c4082f1.js"><link rel="prefetch" href="/blog/assets/index.html.0de70fd1.js"><link rel="prefetch" href="/blog/assets/index.html.60bd5617.js"><link rel="prefetch" href="/blog/assets/index.html.0d94b48a.js"><link rel="prefetch" href="/blog/assets/gauge.html.9242fdf5.js"><link rel="prefetch" href="/blog/assets/hexo.html.17c43d37.js"><link rel="prefetch" href="/blog/assets/tool-library.html.bb17b47f.js"><link rel="prefetch" href="/blog/assets/v2.html.9e92d603.js"><link rel="prefetch" href="/blog/assets/v4.html.0c286980.js"><link rel="prefetch" href="/blog/assets/v5.html.f1ad56f0.js"><link rel="prefetch" href="/blog/assets/index.html.4b0f916c.js"><link rel="prefetch" href="/blog/assets/charles.html.33826ecd.js"><link rel="prefetch" href="/blog/assets/git.html.7db9c803.js"><link rel="prefetch" href="/blog/assets/node-registry-manage.html.1b2cdc59.js"><link rel="prefetch" href="/blog/assets/node-version-manager.html.df861680.js"><link rel="prefetch" href="/blog/assets/vue.html.2b49b4ab.js"><link rel="prefetch" href="/blog/assets/auto-deploy.html.64c9988f.js"><link rel="prefetch" href="/blog/assets/download-by-url.html.a67a7597.js"><link rel="prefetch" href="/blog/assets/download.html.b198b631.js"><link rel="prefetch" href="/blog/assets/get-lastday.html.ea629449.js"><link rel="prefetch" href="/blog/assets/parseInt.html.98c7d1f8.js"><link rel="prefetch" href="/blog/assets/scroll-into-view.html.5b416937.js"><link rel="prefetch" href="/blog/assets/tree-operate.html.651b14bc.js"><link rel="prefetch" href="/blog/assets/index.html.f7073166.js"><link rel="prefetch" href="/blog/assets/app.html.89a14319.js"><link rel="prefetch" href="/blog/assets/index.html.7a9b365f.js"><link rel="prefetch" href="/blog/assets/antd-vue-upload.html.89b8c62c.js"><link rel="prefetch" href="/blog/assets/bind-string.html.dcbb1ebc.js"><link rel="prefetch" href="/blog/assets/component-loop.html.4314b905.js"><link rel="prefetch" href="/blog/assets/elementui-dialog.html.a4d47f42.js"><link rel="prefetch" href="/blog/assets/elementui-dynamic-table.html.92aafbad.js"><link rel="prefetch" href="/blog/assets/elementui-table-auto-height.html.9fa31a16.js"><link rel="prefetch" href="/blog/assets/elementui-table-pagination.html.4634275d.js"><link rel="prefetch" href="/blog/assets/fe-pagination.html.d5986f15.js"><link rel="prefetch" href="/blog/assets/gitlab.html.f824bf85.js"><link rel="prefetch" href="/blog/assets/init-data.html.759e699c.js"><link rel="prefetch" href="/blog/assets/keep-alive.html.797e456b.js"><link rel="prefetch" href="/blog/assets/new-tab.html.d7b8e963.js"><link rel="prefetch" href="/blog/assets/vue-ie9.html.2b6539b5.js"><link rel="prefetch" href="/blog/assets/vue-router-params.html.4c0ce752.js"><link rel="prefetch" href="/blog/assets/index.html.9b575fa9.js"><link rel="prefetch" href="/blog/assets/animation.html.26be75d9.js"><link rel="prefetch" href="/blog/assets/bfc.html.b9658a74.js"><link rel="prefetch" href="/blog/assets/box-model.html.c1cd18e3.js"><link rel="prefetch" href="/blog/assets/center.html.eb450b44.js"><link rel="prefetch" href="/blog/assets/clear.html.2f738939.js"><link rel="prefetch" href="/blog/assets/flex.html.4285a0a0.js"><link rel="prefetch" href="/blog/assets/layout.html.d424e3b8.js"><link rel="prefetch" href="/blog/assets/other.html.37f0e7c3.js"><link rel="prefetch" href="/blog/assets/rem.html.f0c45875.js"><link rel="prefetch" href="/blog/assets/canvas-svg.html.2721e1a5.js"><link rel="prefetch" href="/blog/assets/doctype.html.d75c07f4.js"><link rel="prefetch" href="/blog/assets/other.html.17248146.js"><link rel="prefetch" href="/blog/assets/painting.html.7b7d9b7c.js"><link rel="prefetch" href="/blog/assets/reflow-repaint.html.b790c668.js"><link rel="prefetch" href="/blog/assets/rendering-engine.html.84e2ea43.js"><link rel="prefetch" href="/blog/assets/array.html.61a17121.js"><link rel="prefetch" href="/blog/assets/asyn-single-thread.html.4767b07b.js"><link rel="prefetch" href="/blog/assets/coding.html.461a585a.js"><link rel="prefetch" href="/blog/assets/communications.html.6038c011.js"><link rel="prefetch" href="/blog/assets/data-type.html.f8a9c53e.js"><link rel="prefetch" href="/blog/assets/dom.html.3b646369.js"><link rel="prefetch" href="/blog/assets/engineering.html.835294bd.js"><link rel="prefetch" href="/blog/assets/error.html.16473c5d.js"><link rel="prefetch" href="/blog/assets/es6.html.18c9f2fc.js"><link rel="prefetch" href="/blog/assets/gc.html.e4b41548.js"><link rel="prefetch" href="/blog/assets/http.html.dc6c1bd4.js"><link rel="prefetch" href="/blog/assets/object.html.79d63501.js"><link rel="prefetch" href="/blog/assets/page-performance.html.f3ec665e.js"><link rel="prefetch" href="/blog/assets/prototype-chain.html.cb6bdb89.js"><link rel="prefetch" href="/blog/assets/safe.html.e6dca7fa.js"><link rel="prefetch" href="/blog/assets/scope-closure.html.6d28ad70.js"><link rel="prefetch" href="/blog/assets/string.html.2e2b8996.js"><link rel="prefetch" href="/blog/assets/index.html.ca453ea9.js"><link rel="prefetch" href="/blog/assets/index.html.1a09e1a9.js"><link rel="prefetch" href="/blog/assets/index.html.f41b68e1.js"><link rel="prefetch" href="/blog/assets/docker.html.0d7efcb7.js"><link rel="prefetch" href="/blog/assets/nginx.html.83c1701a.js"><link rel="prefetch" href="/blog/assets/zentao.html.22700c32.js"><link rel="prefetch" href="/blog/assets/index.html.6621ed7b.js"><link rel="prefetch" href="/blog/assets/index.html.c3d7ed8e.js"><link rel="prefetch" href="/blog/assets/index.html.4c423e95.js"><link rel="prefetch" href="/blog/assets/index.html.3b0d18a7.js"><link rel="prefetch" href="/blog/assets/index.html.fd20f3c9.js"><link rel="prefetch" href="/blog/assets/index.html.4ba5c69f.js"><link rel="prefetch" href="/blog/assets/questions.html.21d5d502.js"><link rel="prefetch" href="/blog/assets/reactive.html.60ca5963.js"><link rel="prefetch" href="/blog/assets/render.html.9b196be4.js"><link rel="prefetch" href="/blog/assets/index.html.301c9aec.js"><link rel="prefetch" href="/blog/assets/index.html.b89e950b.js"><link rel="prefetch" href="/blog/assets/index.html.95a1af99.js"><link rel="prefetch" href="/blog/assets/index.html.585b387d.js"><link rel="prefetch" href="/blog/assets/arrow-func.html.ffa847e8.js"><link rel="prefetch" href="/blog/assets/promise.html.33b4d644.js"><link rel="prefetch" href="/blog/assets/Observer.html.6c894035.js"><link rel="prefetch" href="/blog/assets/def.html.e57a7170.js"><link rel="prefetch" href="/blog/assets/defineProperty.html.2b3d8af9.js"><link rel="prefetch" href="/blog/assets/defineReactive.html.38417626.js"><link rel="prefetch" href="/blog/assets/my-observe.html.1a01fecb.js"><link rel="prefetch" href="/blog/assets/observe.html.8a7a3649.js"><link rel="prefetch" href="/blog/assets/dep.html.9c2aa400.js"><link rel="prefetch" href="/blog/assets/watcher.html.d470c51e.js"><link rel="prefetch" href="/blog/assets/404.html.2af7df0e.js"><link rel="prefetch" href="/blog/assets/404.f54f7ae6.js"><link rel="prefetch" href="/blog/assets/Layout.f472a261.js">
    <link rel="stylesheet" href="/blog/assets/style.0988b2b7.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><!----><span class="site-name">Blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/primary/" class="" aria-label="Primary"><!--[--><!--]--> Primary <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/advanced/" class="router-link-active" aria-label="Advanced"><!--[--><!--]--> Advanced <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Framework"><span class="title">Framework</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Framework"><span class="title">Framework</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Vue</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/v3/" class="" aria-label="v3"><!--[--><!--]--> v3 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/v2/" class="" aria-label="v2"><!--[--><!--]--> v2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/vue-router/" class="" aria-label="vue-router"><!--[--><!--]--> vue-router <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/vuex/" class="" aria-label="vuex"><!--[--><!--]--> vuex <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/axios/" class="" aria-label="axios"><!--[--><!--]--> axios <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><a href="/blog/framework/react/" class="" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Bundler"><span class="title">Bundler</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Bundler"><span class="title">Bundler</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Webpack</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/bundler/webpack/v5.md" class="" aria-label="v5"><!--[--><!--]--> v5 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/bundler/webpack/v4.md" class="" aria-label="v4"><!--[--><!--]--> v4 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/bundler/webpack/v2.md" class="" aria-label="v2"><!--[--><!--]--> v2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/bundler/babel.md" class="" aria-label="babel"><!--[--><!--]--> babel <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/blog/job-summary/" class="" aria-label="JobSummary"><!--[--><!--]--> JobSummary <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/audition/" class="" aria-label="HK-Office"><!--[--><!--]--> HK-Office <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/Jerry-bbq?tab=repositories" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换主题"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/primary/" class="" aria-label="Primary"><!--[--><!--]--> Primary <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/advanced/" class="router-link-active" aria-label="Advanced"><!--[--><!--]--> Advanced <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Framework"><span class="title">Framework</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Framework"><span class="title">Framework</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Vue</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/v3/" class="" aria-label="v3"><!--[--><!--]--> v3 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/v2/" class="" aria-label="v2"><!--[--><!--]--> v2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/vue-router/" class="" aria-label="vue-router"><!--[--><!--]--> vue-router <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/vuex/" class="" aria-label="vuex"><!--[--><!--]--> vuex <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/framework/vue/axios/" class="" aria-label="axios"><!--[--><!--]--> axios <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><a href="/blog/framework/react/" class="" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Bundler"><span class="title">Bundler</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Bundler"><span class="title">Bundler</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Webpack</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/blog/bundler/webpack/v5.md" class="" aria-label="v5"><!--[--><!--]--> v5 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/bundler/webpack/v4.md" class="" aria-label="v4"><!--[--><!--]--> v4 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/bundler/webpack/v2.md" class="" aria-label="v2"><!--[--><!--]--> v2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/blog/bundler/babel.md" class="" aria-label="babel"><!--[--><!--]--> babel <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="navbar-item"><a href="/blog/job-summary/" class="" aria-label="JobSummary"><!--[--><!--]--> JobSummary <!--[--><!--]--></a></div><div class="navbar-item"><a href="/blog/audition/" class="" aria-label="HK-Office"><!--[--><!--]--> HK-Office <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://github.com/Jerry-bbq?tab=repositories" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">vue-lazyload源码阅读 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#为什么要读源码" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么要读源码"><!--[--><!--]--> 为什么要读源码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#准备工作" class="router-link-active router-link-exact-active sidebar-item" aria-label="准备工作"><!--[--><!--]--> 准备工作 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#_1-rollupjs" class="router-link-active router-link-exact-active sidebar-item" aria-label="1.Rollupjs"><!--[--><!--]--> 1.Rollupjs <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#_2-vue插件" class="router-link-active router-link-exact-active sidebar-item" aria-label="2.Vue插件"><!--[--><!--]--> 2.Vue插件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#_3-vue指令" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.Vue指令"><!--[--><!--]--> 3.Vue指令 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#_4-全局组件" class="router-link-active router-link-exact-active sidebar-item" aria-label="4.全局组件"><!--[--><!--]--> 4.全局组件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#_5-图片懒加载的原理" class="router-link-active router-link-exact-active sidebar-item" aria-label="5.图片懒加载的原理"><!--[--><!--]--> 5.图片懒加载的原理 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#如何调试源码" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何调试源码"><!--[--><!--]--> 如何调试源码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#目录结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="目录结构"><!--[--><!--]--> 目录结构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#入口文件index" class="router-link-active router-link-exact-active sidebar-item" aria-label="入口文件index"><!--[--><!--]--> 入口文件index <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#lazy类" class="router-link-active router-link-exact-active sidebar-item" aria-label="Lazy类"><!--[--><!--]--> Lazy类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#reactivelistener类" class="router-link-active router-link-exact-active sidebar-item" aria-label="ReactiveListener类"><!--[--><!--]--> ReactiveListener类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#lazycontainer类" class="router-link-active router-link-exact-active sidebar-item" aria-label="LazyContainer类"><!--[--><!--]--> LazyContainer类 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#lazy-component组件" class="router-link-active router-link-exact-active sidebar-item" aria-label="lazy-component组件"><!--[--><!--]--> lazy-component组件 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#util工具函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="util工具函数"><!--[--><!--]--> util工具函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/advanced/share/vue-lazyload/#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="vue-lazyload源码阅读" tabindex="-1"><a class="header-anchor" href="#vue-lazyload源码阅读" aria-hidden="true">#</a> vue-lazyload源码阅读</h1><h2 id="为什么要读源码" tabindex="-1"><a class="header-anchor" href="#为什么要读源码" aria-hidden="true">#</a> 为什么要读源码</h2><ol><li>项目中使用过，但是不是很明白它是怎么实现的</li></ol><p>在开发项目过程中，经常会遇到一个问题，当一个页面中需要加载大量的图片，如果一次性加载完，会浪费网络资源不说，而且页面加载也会出现卡顿，用户体验非常的不好。因此，需要图片懒加载这种技术手段来处理这个问题，然而平时项目都比较赶，最快的方式就去找一个插件来使用。通常vue项目都会选择<a href="https://github.com/hilongjw/vue-lazyload" target="_blank" rel="noopener noreferrer">vue-lazyload<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>这款插件，主要原因是在github上star相对来说比较多。</p><ol start="2"><li>为了不做一个拿来主义者，利用业余时间读下源码，给自己充充电</li></ol><h2 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作" aria-hidden="true">#</a> 准备工作</h2><h3 id="_1-rollupjs" tabindex="-1"><a class="header-anchor" href="#_1-rollupjs" aria-hidden="true">#</a> 1.Rollupjs</h3><p><a href="https://www.rollupjs.com/" target="_blank" rel="noopener noreferrer">Rollupjs<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>是 JavaScript 模块打包器，配置非常的简单，<code>Vue</code>源代码也是使用<code>Rollupjs</code>打包的，非常有必要玩一下</p><h3 id="_2-vue插件" tabindex="-1"><a class="header-anchor" href="#_2-vue插件" aria-hidden="true">#</a> 2.Vue插件</h3><p>自定义插件：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>MyPlugin<span class="token punctuation">.</span><span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 添加全局方法或 property</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">myGlobalMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
  <span class="token comment">// 2. 添加全局指令（这里重点关注）</span>
  Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">&#39;my-directive&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指令第一次绑定到元素时调用，做初始化设置（只调用一次）</span>
    <span class="token function">bind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    <span class="token comment">// 被绑定元素插入父节点时调用</span>
    <span class="token function">inserted</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 所在组件的 虚拟DOM 更新时调用(虚拟DOM更新前，生命周期为beforeUpdate())</span>
    <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 指令所在组件的 虚拟DOM 及其子 虚拟DOM 全部更新后调用（虚拟DOM更新前后,生命周期为updated()）</span>
    <span class="token function">componentUpdated</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 指令与元素解绑时调用（当前组件销毁 或者 指令绑定的元素存在v-if为false）（只调用一次）</span>
    <span class="token function">unbind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 3. 注入组件选项</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">created</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 4. 添加实例方法</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$myMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">methodOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* 逻辑... */</span> <span class="token punctuation">}</span>
  <span class="token comment">// 5. 添加全局组件（这里重点关注）</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><details class="custom-container details"><summary>指令钩子函数的参数</summary><p>指令钩子函数的四个参数<code>el</code>，<code>binding</code>，<code>vnode</code>，<code>oldVnode</code>说明如下：</p><ul><li>el：指令所绑定的DOM元素</li><li>binding：一个对象，包含以下属性： <ul><li>name：指令名，不包括 <code>v-</code> 前缀。</li><li>value：指令的绑定值，例如<code>v-my-directive=&quot;1 + 1&quot;</code> 中，绑定值为 <code>2</code>。</li><li>oldValue：指令绑定的前一个值，仅在 <code>update</code> 和 <code>componentUpdated</code> 钩子中可用</li><li>expression：字符串形式的指令表达式。例如 <code>v-my-directive=&quot;1 + 1&quot;</code> 中，表达式为 <code>&quot;1 + 1&quot;</code>。</li><li>arg：传给指令的参数，可选。例如 <code>v-my-directive:foo</code> 中，参数为 <code>&quot;foo</code>&quot;。</li><li>modifiers：一个包含修饰符的对象。例如 <code>v-my-directive.foo.bar</code> 中，修饰符对象为 <code>{ foo: true, bar: true }</code></li></ul></li><li>vnode：Vue 编译生成的虚拟节点</li><li>oldVnode：上一个虚拟节点，仅在 update 和 componentUpdated 钩子中可用</li></ul></details><p>注册自定义插件并传入参数：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>MyPlugin<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">someOption</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">提示</p><p>官方文档入口<a href="https://cn.vuejs.org/v2/guide/plugins.html" target="_blank" rel="noopener noreferrer">Vue插件系统<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h3 id="_3-vue指令" tabindex="-1"><a class="header-anchor" href="#_3-vue指令" aria-hidden="true">#</a> 3.Vue指令</h3><p>注册全局指令<code>v-focus</code>：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">&#39;focus&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当被绑定的元素插入到 DOM 中时……</span>
  <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 聚焦元素</span>
    el<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>注册局部指令<code>v-focus</code>：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">focus</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指令的定义</span>
    <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用指令：</p><div class="language-vue ext-vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-focus</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">提示</p><p>以上官方提供的demo，具体可查询官方文档<a href="https://cn.vuejs.org/v2/guide/custom-directive.html" target="_blank" rel="noopener noreferrer">Vue自定义指令<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h3 id="_4-全局组件" tabindex="-1"><a class="header-anchor" href="#_4-全局组件" aria-hidden="true">#</a> 4.全局组件</h3><p>注册全局组件：</p><p>函数组件形式：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;component-name&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
  <span class="token comment">// options</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以<code>.vue</code>模板的形式：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token keyword">import</span> ComponentA <span class="token keyword">from</span> <span class="token string">&#39;@/components/ComponentA&#39;</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;component-name&#39;</span><span class="token punctuation">,</span> ComponentA<span class="token punctuation">)</span>
</code></pre></div><h3 id="_5-图片懒加载的原理" tabindex="-1"><a class="header-anchor" href="#_5-图片懒加载的原理" aria-hidden="true">#</a> 5.图片懒加载的原理</h3><p>懒加载的应用场景：当图片出现在视口中时，再加载图片</p><p>实现步骤：</p><ol><li>先将图片的<code>url</code>存放到<code>data-src</code>自定义属性（可随便设置）中（通过<code>el.dataset.src</code>来获取该属性的值）</li><li>实例化<code>Image</code>对象得到缓存对象<code>cacheImg</code></li><li>判断图片是否出现在视口中<code>checkInView</code></li><li>如果图片出现在视口中，将图片的<code>data-src</code>赋值给<code>cacheImg</code>的<code>src</code>，加载图片</li><li>通过事件<code>onload</code>，判断图片加载成功，如果是，则将<code>cacheImg</code>的<code>src</code>赋值给图片的<code>src</code></li><li>通过事件<code>onerror</code>，判断图片失败，这时，将<code>error</code>图片的url赋值给图片的<code>src</code></li></ol><p>简单实现：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token function">preloadImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取img dom的集合 imgList</span>
  <span class="token keyword">const</span> imgList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">&#39;img&#39;</span><span class="token punctuation">)</span>
  <span class="token comment">// 遍历 imgList</span>
  imgList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例化Image对象</span>
    <span class="token keyword">let</span> cacheImg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 检查图片是否出现在视口中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkInView</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// 将 data-src 中的值赋值给 cacheImg 的 src，此时会加载图片</span>
      cacheImg<span class="token punctuation">.</span>src <span class="token operator">=</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src
      <span class="token comment">// 图片加载完成</span>
      cacheImg<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将 img.src 设置给对应的 el src</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span> cacheImg<span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 图片加载失败</span>
      img<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置 error 图片</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span> <span class="token string">&#39;./error.jpg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如何判断图片是否出现在视口中：</p><ul><li>第一种方式：通过监听<code>scroll</code>等事件，调用目标元素的<a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect" target="_blank" rel="noopener noreferrer">getBoundingClientRect()<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>方法，得到它相对于视口的坐标，即可判断是否出现在视口中</li></ul><p>getBoundingClientRect的图解：</p><p><img src="/blog/assets/getBoundingClientRect.0fbdfc36.png" alt="getBoundingClientRect"></p><p>实现：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token function">checkInView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rect <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 获取当前dom元素的大小及其相对于视口的位置</span>
  <span class="token keyword">const</span> height <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight <span class="token comment">// 视口高度</span>
  <span class="token keyword">const</span> width <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth  <span class="token comment">// 视口宽度</span>
  <span class="token keyword">const</span> yInView <span class="token operator">=</span> rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> height <span class="token operator">&amp;&amp;</span> rect<span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token comment">// 纵向出现在视口中</span>
  <span class="token keyword">const</span> xInView <span class="token operator">=</span> rect<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> width <span class="token operator">&amp;&amp;</span> rect<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token comment">// 横向出现在视口中</span>
  <span class="token keyword">return</span> yInView <span class="token operator">&amp;&amp;</span> xInView
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>第二种方式：浏览器自带的 交叉观察器 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API" target="_blank" rel="noopener noreferrer">IntersectionObserver<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> api</li></ul><p>简单实现：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token function">createObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 定义参数</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 视口,默认是 null,即document对象</span>
    <span class="token literal-property property">rootMargin</span><span class="token operator">:</span> <span class="token string">&#39;0px&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 围绕视口的边距</span>
    <span class="token literal-property property">threshold</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 阈值，数组或者数字，表示在目标元素在视口中出现的百分比是多少时，再去触发回调函数</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
    * 2. 定义会调用回调函数，目标元素与视口相交时会调用该回调函数
    * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">entries</span> IntersectionObserverEntry的集合
    * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">observer</span> IntersectionObserver的实例
    */</span>
  <span class="token keyword">const</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">entries<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(entries, &#39;entries&#39;)</span>
    entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用observe方法的时，会触发一次回调函数，因此需要判断是否交叉</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// entry.target 被观察的DOM元素</span>
        <span class="token comment">// observe === observer</span>
        <span class="token comment">// observe.unobserve(document.getElementById(&#39;element&#39;))</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// console.log(observe === observer)</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
    * 3. 创建观察器实例，异步观察目标元素与视口相交的变化
    * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">callback</span> 目标元素的可见性变化时,调用的回调函数
    * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">options</span> 参数
    */</span>
  <span class="token keyword">const</span> observe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

  <span class="token comment">// 4. 指定 DOM节点 开始观察</span>
  observe<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;element&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 取消指定 DOM节点 的观察</span>
  <span class="token comment">// observe.unobserve(document.getElementById(&#39;element&#39;))</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="如何调试源码" tabindex="-1"><a class="header-anchor" href="#如何调试源码" aria-hidden="true">#</a> 如何调试源码</h2><ol><li>首先从<code>github</code>上将<a href="https://github.com/hilongjw/vue-lazyload" target="_blank" rel="noopener noreferrer">vue-lazyload<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>源码<code>clone</code>下来</li><li>创建一个<code>Vue</code>项目,这里我使用<a href="https://cli.vuejs.org/" target="_blank" rel="noopener noreferrer">Vue CLI<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>脚手架创建</li></ol><div class="language-bash ext-sh"><pre class="language-bash"><code>vue create lazy
<span class="token builtin class-name">cd</span> lazy
<span class="token function">yarn</span> serve
</code></pre></div><ol start="3"><li>将<code>vue-lazyload</code>源码中的<code>src</code>目录copy到上面创建的项目中，并<code>src</code>目录改名为<code>vue-lazyload</code>(可以自己随便定义)</li><li>在<code>main.js</code>文件引入，并注册插件</li></ol><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;./App.vue&#39;</span>
<span class="token keyword">import</span> Lazyload <span class="token keyword">from</span> <span class="token string">&#39;./vue-lazyload&#39;</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Lazyload<span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">&#39;#app&#39;</span><span class="token punctuation">)</span>

</code></pre></div><div class="custom-container warning"><p class="custom-container-title">警告</p><p>由于<code>vue-lazyload</code>项目中引入插件<code>assign-deep</code>,所以需要先手动安装下这个插件, 执行命令<code>yarn install assign-deep</code>即可</p></div><ol start="5"><li>以上步骤完成之后，就可以启动自己的项目，随便的调试源码了</li></ol><p>至此，准备工作已经完全做完，下面正式开始解读源码！</p><h2 id="目录结构" tabindex="-1"><a class="header-anchor" href="#目录结构" aria-hidden="true">#</a> 目录结构</h2><div class="language-bash ext-sh"><pre class="language-bash"><code>├── src
│   ├── index.js
│   ├── lazy-component.js
│   ├── lazy-container.js
│   ├── lazy-image.js
│   ├── lazy.js
│   ├── listener.js
│   └── util.js
</code></pre></div><p>目录解读：</p><ul><li>index.js：入口文件</li><li>lazy-component.js：懒加载组件</li><li>lazy-container.js：懒加载容器</li><li>lazy-image.js：官方文档中尚未列出参数<code>lazyImage</code>,暂不分析</li><li>lazy.js：懒加载类</li><li>listener.js：监听类</li><li>util.js：工具函数</li></ul><h2 id="入口文件index" tabindex="-1"><a class="header-anchor" href="#入口文件index" aria-hidden="true">#</a> 入口文件index</h2><p>首先从入口文件<code>index.js</code>开始下手, 其中包含了一些<code>vue1.0</code>版本相关的兼容性代码，<code>vue3.0</code>即将在8月份来临，还有人在用<code>vue1.0</code>？因此，注释掉<code>vue1.0</code>相关的兼容性代码，代码结构也会显得更加的简单明了。</p><p>源码解析如下：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token keyword">import</span> Lazy <span class="token keyword">from</span> <span class="token string">&#39;./lazy&#39;</span>
<span class="token keyword">import</span> LazyComponent <span class="token keyword">from</span> <span class="token string">&#39;./lazy-component&#39;</span>
<span class="token keyword">import</span> LazyContainer <span class="token keyword">from</span> <span class="token string">&#39;./lazy-container&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// 插件提供install方法用于注册，传入两个参数，分别为`Vue`, `options`(自定义参数)</span>
  <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行`Lazy`函数，传入参数`Vue`，返回`LazyClass`类</span>
    <span class="token keyword">const</span> LazyClass <span class="token operator">=</span> <span class="token function">Lazy</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
    <span class="token comment">// 实例化`LazyClass`类，传入自定义参数`options`, 得到实例`lazy`</span>
    <span class="token keyword">const</span> lazy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyClass</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    
    <span class="token comment">// 实例化`LazyContainer`，并传入实例`{ lazy }`，得到实例`lazyContainer`</span>
    <span class="token keyword">const</span> lazyContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyContainer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> lazy <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 将实例`lazy`挂载到`Vue`的原型属性`$Lazyload`上</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$Lazyload <span class="token operator">=</span> lazy

    <span class="token comment">// 注册组件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>lazyComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行 LazyComponent()，传入 `lazy`实例，返回一个Vue组件</span>
      Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;lazy-component&#39;</span><span class="token punctuation">,</span> <span class="token function">LazyComponent</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 注册全局指令`v-lazy`</span>
    Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">&#39;lazy&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 指令第一次绑定到元素时，执行 lazy.add()</span>
      <span class="token literal-property property">bind</span><span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 所在组件的 虚拟DOM 更新时，执行初始化，执行 lazy.update()</span>
      <span class="token literal-property property">update</span><span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 指令所在的 虚拟DOM 及 其子虚拟DOM 全部更新后，执行 lazy.lazyLoadHandler()</span>
      <span class="token literal-property property">componentUpdated</span><span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span><span class="token punctuation">,</span> 
      <span class="token comment">// 指令与元素解绑时, 执行 lazy.remove()</span>
      <span class="token literal-property property">unbind</span><span class="token operator">:</span> lazy<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazy<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 注册全局指令`v-lazy-container`</span>
    Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">&#39;lazy-container&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bind</span><span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// lazyContainer.bind()</span>
      <span class="token literal-property property">componentUpdated</span><span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// lazyContainer.update</span>
      <span class="token literal-property property">unbind</span><span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span> <span class="token comment">// lazyContainer.unbind</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从上面的分析，可以看出来，入口文件做了如下几件事：</p><ul><li>提供了注册插件的入口<code>install</code></li><li>在注册插件的同时，注册了 <code>lazy-component</code>全局组件</li><li>在注册插件的同时，注册了 <code>v-lazy</code>, <code>v-lazy-container</code> 全局指令</li></ul><div class="custom-container warning"><p class="custom-container-title">WARNING</p><ol><li>以上定义的钩子函数都带有一个<code>bind</code>，是为了使得函数中的<code>this</code>指向<code>Lazy</code>类或<code>LazyContainerMananger</code>类，若不绑定 <code>this</code> 会指向 <code>undefined</code></li><li>不可以使用<code>call</code>或者<code>apply</code>，因为会立即执相应的函数</li></ol></div><p>当我们使用<code>v-lazy</code>指令的时候，也就是指令<code>v-lazy</code>第一次绑定到元素时，会触发<code>bind</code>钩子函数，也就是<code>lazy.add()</code>方法，而这个方法是定义在<code>Lazy</code>类当中的，因此接下来，分析下<code>Lazy</code>类的实现</p><h2 id="lazy类" tabindex="-1"><a class="header-anchor" href="#lazy类" aria-hidden="true">#</a> Lazy类</h2><p>功能：懒加载的主要功能都在这个类中实现</p><p>由于<code>lazy.js</code>文件中的代码较多，为了有一个全局观，先看下<code>Lazy</code>类的大致结构,如下所示为简化后的代码：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token comment">/* 一系列的工具方法，下面会介绍到 */</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./util&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 监听器，这个是vue-lazyload的核心，后面在去理解</span>
<span class="token keyword">import</span> ReactiveListener <span class="token keyword">from</span> <span class="token string">&quot;./listener&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">Lazy</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>preLoad<span class="token punctuation">,</span> error<span class="token punctuation">,</span>throttleWait<span class="token punctuation">,</span><span class="token comment">/* ...插件支持的用户入参 */</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 监听队列，用来存放监听器</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>TargetIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>TargetQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">silent</span><span class="token operator">:</span> silent<span class="token punctuation">,</span> 
        <span class="token literal-property property">dispatchEvent</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>dispatchEvent<span class="token punctuation">,</span>
        <span class="token literal-property property">throttleWait</span><span class="token operator">:</span> throttleWait <span class="token operator">||</span> <span class="token number">200</span><span class="token punctuation">,</span> 
        <span class="token comment">// ...还有很多的参数属性</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lazyLoadHandler <span class="token operator">=</span> <span class="token function">throttle</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_lazyLoadHandler</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>throttleWait
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setMode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>observer <span class="token operator">?</span> modeType<span class="token punctuation">.</span>observer <span class="token operator">:</span> modeType<span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">addLazyBox</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****bind钩子函数</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****update钩子函数</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****unbind钩子函数</span>
    <span class="token function">removeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">setMode</span><span class="token punctuation">(</span><span class="token parameter">mode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_addListenerTarget</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_removeListenerTarget</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_initListen</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> start</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// *****componentUpdated钩子函数</span>
    <span class="token function">_initIntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_observerHandler</span><span class="token punctuation">(</span><span class="token parameter">entries<span class="token punctuation">,</span> observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_elRenderer</span><span class="token punctuation">(</span><span class="token parameter">listener<span class="token punctuation">,</span> state<span class="token punctuation">,</span> cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">_valueFormatter</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>add()</code>方法实现的大致流程：</p><p><img src="/blog/assets/add.6aeb25fd.png" alt="add"></p><p>可以看出，插件内部维护了一个监听队列<code>ListenerQueue</code>，来存储监听器 <code>listener</code>对象，通过遍历监听队列<code>ListenerQueue</code>，最终实现每张图片的懒加载</p><p><code>add()</code>方法的源码：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 通过 DOM元素 判断监听器是否已存在于监听队列中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已存在，则调用更新方法 update</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在下一次DOM更新循环之后，执行lazyLoadHandler</span>
    <span class="token keyword">return</span> Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazyLoadHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 根据binding.value，获取图片的真实src, loading, error</span>
  <span class="token comment">// cors获取不到，因为_valueFormatter没有返回cors</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error<span class="token punctuation">,</span> cors <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_valueFormatter</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 由于这个时候DOM还没有渲染完成，需要做一些dom的操作，必须在nextTick中完成</span>
  Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//  如果el不是img标签 或者 该dom不包含属性data-srcset使用src</span>
    src <span class="token operator">=</span> <span class="token function">getBestSelectionFromSrcset</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>scale<span class="token punctuation">)</span> <span class="token operator">||</span> src<span class="token punctuation">;</span>

    <span class="token comment">// 使用交叉观察者模式观察dom元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observer <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取修饰符</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义父级dom元素</span>
    <span class="token keyword">let</span> $parent<span class="token punctuation">;</span>
    <span class="token comment">// 如果修饰符存在 ???</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $parent <span class="token operator">=</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">.</span>$refs<span class="token punctuation">[</span>container<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// if there is container passed in, try ref first, then fallback to getElementById to support the original usage</span>
      $parent <span class="token operator">=</span> $parent
        <span class="token operator">?</span> $parent<span class="token punctuation">.</span>$el <span class="token operator">||</span> $parent
        <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回window对象</span>
      $parent <span class="token operator">=</span> <span class="token function">scrollParent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> newListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveListener</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// bindType，传给指令的参数,例如 v-lazy:background-image=&quot;imgUrl&quot; 中，参数为 &quot;background-image&quot;</span>
      <span class="token comment">// 目前就是css的background-image属性</span>
      <span class="token literal-property property">bindType</span><span class="token operator">:</span> binding<span class="token punctuation">.</span>arg<span class="token punctuation">,</span> 
      $parent<span class="token punctuation">,</span> <span class="token comment">// 父级dom元素</span>
      el<span class="token punctuation">,</span> <span class="token comment">// 当前dom元素</span>
      loading<span class="token punctuation">,</span> <span class="token comment">// 图片loading地址</span>
      error<span class="token punctuation">,</span> <span class="token comment">// 图片error地址</span>
      src<span class="token punctuation">,</span> <span class="token comment">// 图片真实src地址</span>
      cors<span class="token punctuation">,</span> <span class="token comment">// 这是获取不到的</span>
      <span class="token literal-property property">elRenderer</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_elRenderer</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 实例化ReactiveListener的时候会执行，传入参数 &quot;loading&quot;, false</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token comment">// 参数</span>
      <span class="token literal-property property">imageCache</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache<span class="token punctuation">,</span> <span class="token comment">// 图片缓存实例</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ListenerQueue 添加 listener</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newListener<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TargetQueue 添加 target，</span>
      <span class="token comment">// 为DOM元素（el）遍历监听事件，添加事件监听，el分别设置为：window，$parent</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addListenerTarget</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_addListenerTarget</span><span class="token punctuation">(</span>$parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行懒加载</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 有无必要在嵌套一个异步更新DOM???</span>
    Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-container warning"><p class="custom-container-title">疑问</p><p>有必要在<code>Vue.nextTick</code>中再次去调用一次<code>Vue.nextTick(() =&gt; this.lazyLoadHandler());</code>？？？</p></div><p>当虚拟dom更新时，会调用<code>lazy.update</code>方法，<code>update()</code>方法的实现的大致流程：</p><p><img src="/blog/assets/update.af430edc.png" alt="update"></p><p><code>update()</code>的实现源码如下：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_valueFormatter</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  src <span class="token operator">=</span> <span class="token function">getBestSelectionFromSrcset</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>scale<span class="token punctuation">)</span> <span class="token operator">||</span> src<span class="token punctuation">;</span>

  <span class="token comment">// 查询监听队列中图片监听器是否已存在</span>
  <span class="token keyword">const</span> exist <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不存在则调用 add方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果已存在，则调用图片监听器的update方法，替换图片的src</span>
    exist<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      src<span class="token punctuation">,</span>
      loading<span class="token punctuation">,</span>
      error<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果是使用 IntersectionObserver api，则先取消观察，在重新观察</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-container warning"><p class="custom-container-title">疑问</p><p>在指令钩子函数<code>componentUpdated</code>已经调用了一次<code>lazyLoadHandler</code>，是否有必要再次调用一次<code>Vue.nextTick(() =&gt; this.lazyLoadHandler());</code>？？？</p></div><p>当指令与元素解绑时，调用<code>lazy.remove</code>方法，<code>remove()</code>方法的大致实现流程图：</p><p><img src="/blog/assets/remove.fbd7290e.png" alt="remove"></p><p><code>remove()</code>的源码：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_observer <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observer<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> existItem <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>existItem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 为什么要执行两次，因为add()方法中_addListenerTarget执行了两次，分别传入window，$parent</span>
    <span class="token comment">// 删除 TargetQueue 中指定的el</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeListenerTarget</span><span class="token punctuation">(</span>existItem<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除 TargetQueue 中指定的el</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_removeListenerTarget</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除 ListenerQueue 中指定的 listener</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ListenerQueue<span class="token punctuation">,</span> existItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化这部分数据</span>
    existItem<span class="token punctuation">.</span><span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="reactivelistener类" tabindex="-1"><a class="header-anchor" href="#reactivelistener类" aria-hidden="true">#</a> ReactiveListener类</h2><p>主要是维护<code>ReactiveListener</code>类</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> loadImageAsync<span class="token punctuation">,</span> ObjectKeys<span class="token punctuation">,</span> noop <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./util&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveListener</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token punctuation">,</span> <span class="token comment">// 当前dom元素</span>
    src<span class="token punctuation">,</span> <span class="token comment">// 图片的真实url</span>
    error<span class="token punctuation">,</span> <span class="token comment">// 图片加载错误的url</span>
    loading<span class="token punctuation">,</span> <span class="token comment">// 图片加载中的url</span>
    bindType<span class="token punctuation">,</span> <span class="token comment">// css属性</span>
    $parent<span class="token punctuation">,</span> <span class="token comment">// 父元素</span>
    options<span class="token punctuation">,</span> <span class="token comment">// 参数</span>
    cors<span class="token punctuation">,</span> <span class="token comment">// 跨域</span>
    elRenderer<span class="token punctuation">,</span> <span class="token comment">// dom元素渲染</span>
    imageCache<span class="token punctuation">,</span> <span class="token comment">// 图片缓存</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> el<span class="token punctuation">;</span> <span class="token comment">// 当前dom元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span> <span class="token comment">// 图片的真实 url</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span> <span class="token comment">// 图片加载错误的 url</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> loading<span class="token punctuation">;</span> <span class="token comment">// 图片加载中的 url</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bindType <span class="token operator">=</span> bindType<span class="token punctuation">;</span> <span class="token comment">// css属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 尝试加载次数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cors <span class="token operator">=</span> cors<span class="token punctuation">;</span> <span class="token comment">// 跨域</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>naturalHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 真实高度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>naturalWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 真实宽度</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span> <span class="token comment">// 参数</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>rect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// getBoundingClientRect 对象</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">=</span> $parent<span class="token punctuation">;</span> <span class="token comment">// 父元素</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>elRenderer <span class="token operator">=</span> elRenderer<span class="token punctuation">;</span> <span class="token comment">// dom元素渲染</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache <span class="token operator">=</span> imageCache<span class="token punctuation">;</span> <span class="token comment">// 图片缓存</span>

    <span class="token comment">// 性能</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>performanceData <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">init</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loadStart</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loadEnd</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过自定义方法，动态修改图片的src</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化状态</span>
    <span class="token comment">// 将图片的url设置到data-src，初始化state的loading，error，loaded，rendered都为false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化渲染，传入图片加载状态loading，缓存状态false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loading&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 初始化状态
   * init listener state
   * 作用：
   * 1. 将图片的url设置到自定义的 data-src 属性上
   * 2. 初始化 this.state 对象，loading，error，loaded，rendered
   */</span>
  <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置 data-src</span>
    <span class="token comment">// 处理dataset的兼容性问题，https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/dataset</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;dataset&quot;</span> <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 通过in方法，判断 dataset属性 是否 存在与DOM对象上</span>
      <span class="token comment">// 通过 dataset 设置自定义属性 data-src</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过 setAttribute 设置自定义属性 data-src</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;data-src&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">loading</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">loaded</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">rendered</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 记录执行时间
   * record performance
   * @return
   */</span>
  <span class="token function">record</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>performanceData<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 如果老的图片url 不等于 新的url，则，初始化initState，src为新的url
   * update image listener data
   * @param  {String} image uri
   * @param  {String} loading image uri
   * @param  {String} error image uri
   * @return
   */</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> src<span class="token punctuation">,</span> loading<span class="token punctuation">,</span> error <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldSrc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>src <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> loading<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
    <span class="token comment">// 通过自定义方法，动态修改图片的src</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldSrc <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * get el node rect
   * @return
   */</span>
  <span class="token function">getRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 当前元素是否出现在视口中, true-是，false-否
   *  check el is in view
   * @return {Boolean} el is in view
   */</span>
  <span class="token function">checkInView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoadTop <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 通过自定义方法，动态修改图片的src
   * listener filter
   */</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ObjectKeys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行过滤函数</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>filter<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 渲染loading
   * render loading first
   * @params cb:Function
   * @return
   */</span>
  <span class="token function">renderLoading</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 图片的loading状态更改为true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// 异步渲染图片</span>
    <span class="token function">loadImageAsync</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loading<span class="token punctuation">,</span>
        <span class="token literal-property property">cors</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cors<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loading&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 图片的loading状态更改为false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// handler `loading image` load failed</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 图片的loading状态更改为false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>silent<span class="token punctuation">)</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VueLazyload log: load failed with loading image(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>loading<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 加载图片，并渲染出来
   * try load image and  render it
   * @return
   */</span>
  <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">onFinish <span class="token operator">=</span> noop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 尝试加载次数大于自定义的尝试加载次数，并his.state.error</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>attempt <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>silent<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">VueLazyload log: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> tried too more than </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>attempt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 图片已加载并渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>rendered <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// 图片已缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 加载图片</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loaded&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>rendered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 渲染图片</span>
      <span class="token keyword">return</span> <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 渲染加载中的状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderLoading</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>attempt<span class="token operator">++</span><span class="token punctuation">;</span>

      <span class="token comment">// 在图片beforeLoad阶段做自定义的事情</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>adapter<span class="token punctuation">[</span><span class="token string">&quot;beforeLoad&quot;</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>adapter<span class="token punctuation">[</span><span class="token string">&quot;beforeLoad&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 性能测试-loadStart</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string">&quot;loadStart&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">loadImageAsync</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">,</span>
          <span class="token literal-property property">cors</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cors<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>naturalHeight <span class="token operator">=</span> data<span class="token punctuation">.</span>naturalHeight<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>naturalWidth <span class="token operator">=</span> data<span class="token punctuation">.</span>naturalWidth<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 图片的loaded状态更改为true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 图片的error状态更改为false</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token string">&quot;loadEnd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 性能测试-loadEnd</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;loaded&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>rendered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 图片的rendered状态更改为true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_imageCache<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将图片url缓存</span>
          <span class="token function">onFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 图片加载出错</span>
          <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>silent <span class="token operator">&amp;&amp;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 图片的error状态更改为true</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 图片的loaded状态更改为false</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 渲染图片
   * render image
   * @param  {String} state to render // [&#39;loading&#39;, &#39;src&#39;, &#39;error&#39;]
   * @param  {String} is form cache
   * @return
   */</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">elRenderer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 性能测试
   * output performance data
   * @return {Object} performance data
   */</span>
  <span class="token function">performance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token string">&quot;loading&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state <span class="token operator">=</span> <span class="token string">&quot;loaded&quot;</span><span class="token punctuation">;</span>
      time <span class="token operator">=</span>
        <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>performanceData<span class="token punctuation">.</span>loadEnd <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>performanceData<span class="token punctuation">.</span>loadStart<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>error<span class="token punctuation">)</span> state <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>src<span class="token punctuation">,</span>
      state<span class="token punctuation">,</span>
      time<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
   * 销毁
   * $destroy
   * @return
   */</span>
  <span class="token function">$destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loading <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bindType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="lazycontainer类" tabindex="-1"><a class="header-anchor" href="#lazycontainer类" aria-hidden="true">#</a> LazyContainer类</h2><p>全局指令<code>v-lazy-container</code>，定义：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">&#39;lazy-container&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bind</span><span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">componentUpdated</span><span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">unbind</span><span class="token operator">:</span> lazyContainer<span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>lazyContainer<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>功能：当图片出现在视口中时，再去加载图片</p><p>使用的方式：</p><div class="language-vue ext-vue"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-lazy-container</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ selector: <span class="token punctuation">&#39;</span>img<span class="token punctuation">&#39;</span>, error: <span class="token punctuation">&#39;</span>xxx.jpg<span class="token punctuation">&#39;</span>, loading: <span class="token punctuation">&#39;</span>xxx.jpg<span class="token punctuation">&#39;</span> }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img1.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img2.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img3.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

或者

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-lazy-container</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ selector: <span class="token punctuation">&#39;</span>img<span class="token punctuation">&#39;</span> }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img1.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-error</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img2.jpg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>xxx.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">data-src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//domain.com/img3.jpg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>lazy-container.js</code>源码：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  find<span class="token punctuation">,</span>
  remove<span class="token punctuation">,</span>
  assign<span class="token punctuation">,</span>
  ArrayFrom
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./util&#39;</span>

<span class="token comment">// 定义一个 LazyContainerMananger类</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">LazyContainerMananger</span> <span class="token punctuation">{</span>
  <span class="token comment">// 接受实例化之后的lazy类</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> lazy <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> lazy
    lazy<span class="token punctuation">.</span>lazyContainerMananger <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 定义队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 指令第一绑定时</span>
  <span class="token function">bind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例化 LazyContainer</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyContainer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> <span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 将实例化之后的LazyContainer存储到队列_queue中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 虚拟dom更新时，查询到队列 _queue 中需要更新的 container，调用update方法</span>
  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">)</span> <span class="token keyword">return</span>
    container<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 查询队列中需要解绑的 container，调用clear方法，然后在将该container从队列中移除</span>
  <span class="token function">unbind</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">,</span> <span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>el <span class="token operator">===</span> el<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>container<span class="token punctuation">)</span> <span class="token keyword">return</span>
    container<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_queue<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 默认选择img标签</span>
<span class="token keyword">const</span> defaultOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token string">&#39;img&#39;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 定义 LazyContainer类</span>
<span class="token keyword">class</span> <span class="token class-name">LazyContainer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> lazy <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment">// 默认 el为 null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vnode <span class="token operator">=</span> vnode <span class="token comment">// 获取指令钩子函数的参数 虚拟DOM</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>binding <span class="token operator">=</span> binding <span class="token comment">// 获取指令钩子函数的参数 binding</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 定义参数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> lazy <span class="token comment">// 获取实例化的lazy类</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 定义队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 更新</span>
  <span class="token punctuation">}</span>

  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> el<span class="token punctuation">,</span> binding <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> el
    <span class="token comment">// 合并参数 defaultOptions，binding.value </span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> defaultOptions<span class="token punctuation">,</span> binding<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

    <span class="token comment">// 获取img DOM对象的集合</span>
    <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getImgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历imgDOM对象的集合</span>
    imgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用lazy类的add()方法，传入参数el、合并 this.binding与自定义的value、虚拟DOM</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>binding<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// 需要设置 data-src为 img的url</span>
          <span class="token literal-property property">src</span><span class="token operator">:</span> <span class="token string">&#39;dataset&#39;</span> <span class="token keyword">in</span> el <span class="token operator">?</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src <span class="token operator">:</span> el<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;data-src&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token comment">// 使用data-error属性为每个元素设置error图片，获取使用全局的 error 参数</span>
          <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">&#39;dataset&#39;</span> <span class="token keyword">in</span> el <span class="token operator">?</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>error <span class="token operator">:</span> el<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;data-error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>error<span class="token punctuation">,</span>
          <span class="token comment">// 使用data-loading属性为每个元素设置loading图片，获取使用全局的 loading 参数</span>
          <span class="token literal-property property">loading</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token string">&#39;dataset&#39;</span> <span class="token keyword">in</span> el <span class="token operator">?</span> el<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>loading <span class="token operator">:</span> el<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;data-loading&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>loading
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将选择器获得的 全部img DOM对象类数组 转化为 数组</span>
  <span class="token function">getImgs</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">ArrayFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 清除</span>
  <span class="token function">clear</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> imgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getImgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 调用lazy的remove方法清除</span>
    imgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>vnode <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>binding <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="lazy-component组件" tabindex="-1"><a class="header-anchor" href="#lazy-component组件" aria-hidden="true">#</a> lazy-component组件</h2><p>全局组件<code>lazy-component</code>，该组件是一个<code>函数组件</code>，是为了要将<code>lazy</code>作为参数传递</p><p><code>lazy-component.js</code>源码：</p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> inBrowser <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./util&#39;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">lazy</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">&#39;div&#39;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 使用插槽 this.$slots.default</span>
      <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>show <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">loaded</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rect</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">show</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el <span class="token comment">// 获取当前dom对象</span>
      lazy<span class="token punctuation">.</span><span class="token function">addLazyBox</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// 将 vm 添加到 ListenerQueue 中，添加事件</span>
      <span class="token comment">// 执行懒加载，此时this指向当前组件，会调用组件中定义的getRect，checkInView，load，destroy方法</span>
      lazy<span class="token punctuation">.</span><span class="token function">lazyLoadHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">beforeDestroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将该 vm 从队列 ListenerQueue 中移除，移除事件</span>
      lazy<span class="token punctuation">.</span><span class="token function">removeComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前组件对象</span>
      <span class="token function">getRect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rect <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">checkInView</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> inBrowser <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> lazy<span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">*</span> lazy<span class="token punctuation">.</span>options<span class="token punctuation">.</span>preLoad <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rect<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">load</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>show <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token comment">// 提供事件 show，参数为当前组件对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">&#39;show&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">destroy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$destroy
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-container warning"><p class="custom-container-title">提示</p><p>使用该组件，如果容器中没有其他的DOM元素，rect对象的top，bottom，left，right都是0，则不会执行load方法，即不会渲染图片</p></div><h2 id="util工具函数" tabindex="-1"><a class="header-anchor" href="#util工具函数" aria-hidden="true">#</a> util工具函数</h2><p><code>util.js</code>工具函数库，包括如下工具函数：</p><ul><li>ImageCache：定义ImageCache类用来存储图片，包括has，add，free方法</li><li>inBrowser：判断window是否存在</li><li>CustomEvent：自定义事件对象CustomEvent</li><li>remove：删除数组中的指定元素</li><li>some：判断数组中是否存在某个函数</li><li>find：查询数组中的某个函数</li><li>assign：深度合并对象，使用<code>assign-deep</code></li><li>noop：空函数</li><li>ArrayFrom： 将类数组转化数组</li><li>_：添加自定义事件，移除自定义事件</li><li>isObject：是否是对象</li><li>throttle：节流函数</li><li>supportWebp：是否支持Webp</li><li>getDPR：获取独立像素比/分辨率，devicePixelRatio</li><li>scrollParent： 返回window对象</li><li>loadImageAsync：异步加载图片</li><li>getBestSelectionFromSrcset：根据独立像素比，设置不同的图片</li><li>ObjectKeys：获取对象的keys</li></ul><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>通过阅读<code>vue-lazyload</code>源码，收获如下：</p><ul><li><code>Vue</code>自定义插件（包括自定义组件，自定义指令）</li><li>对图片懒加载的实现有了全新的认识</li></ul><p><code>vue-lazyload</code>通过会维护一个<code>ListenerQueue</code>队列来实现图片的懒加载，代码执行主流程如下：</p><p><img src="/blog/assets/main.14977d72.png" alt="main"></p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/blog/assets/app.5bb0e60c.js" defer></script>
  </body>
</html>
