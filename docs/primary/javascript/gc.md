# åƒåœ¾å›æ”¶æœºåˆ¶ä¸å†…å­˜æ³„æ¼

## ä¸€ã€åƒåœ¾å›æ”¶ï¼ˆGarbage Collection, GCï¼‰

### 1.1 ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼Ÿ

**åƒåœ¾å›æ”¶**ï¼ˆGCï¼‰æ˜¯ JavaScript å¼•æ“è‡ªåŠ¨ç®¡ç†å†…å­˜çš„æœºåˆ¶ï¼š  
å½“å¯¹è±¡**ä¸å†è¢«ç¨‹åºä½¿ç”¨**æ—¶ï¼Œå¼•æ“ä¼šè‡ªåŠ¨é‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ã€‚

> ğŸ’¡ ç¨‹åºå‘˜æ— éœ€æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ï¼ˆå¦‚ C/C++ ä¸­çš„ `free`ï¼‰ï¼Œä½†éœ€**é¿å…é˜»ç¢ GC çš„è¡Œä¸º**ã€‚
 
### 1.2 ä¸ºä»€ä¹ˆè¦ GCï¼Ÿ

- ç¨‹åºè¿è¡Œéœ€è¦å†…å­˜èµ„æºï¼›
- è‹¥ä¸åŠæ—¶é‡Šæ”¾æ— ç”¨å†…å­˜ï¼Œä¼šå¯¼è‡´ï¼š
  - å†…å­˜å ç”¨æŒç»­å¢é•¿
  - ç³»ç»Ÿæ€§èƒ½ä¸‹é™
  - æµè§ˆå™¨å¡é¡¿ç”šè‡³å´©æºƒï¼ˆå°¤å…¶åœ¨é•¿æœŸè¿è¡Œçš„ SPA åº”ç”¨ä¸­ï¼‰
 
### 1.3 ä¸»æµ GC ç®—æ³•

#### âœ… 1. æ ‡è®°-æ¸…é™¤ï¼ˆMark-and-Sweepï¼‰ã€ç°ä»£å¼•æ“ä¸»æµã€‘

- **åŸç†**ï¼š
  1. ä»**æ ¹å¯¹è±¡**ï¼ˆå¦‚å…¨å±€å¯¹è±¡ã€å½“å‰æ‰§è¡Œæ ˆï¼‰å‡ºå‘ï¼Œæ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼›
  2. æœªè¢«æ ‡è®°çš„å¯¹è±¡è§†ä¸ºâ€œåƒåœ¾â€ï¼Œäºˆä»¥æ¸…é™¤ã€‚
- **ä¼˜ç‚¹**ï¼šèƒ½å¤„ç†å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚
- **V8 å®é™…ä½¿ç”¨**ï¼šåŸºäºæ­¤ç®—æ³•ï¼Œå¹¶å¼•å…¥**åˆ†ä»£å›æ”¶**ï¼ˆGenerational GCï¼‰ä¼˜åŒ–æ€§èƒ½ã€‚

> ğŸ“Œ **V8 åˆ†ä»£ç­–ç•¥**ï¼š
> - **æ–°ç”Ÿä»£**ï¼ˆYoung Generationï¼‰ï¼šæ–°åˆ›å»ºå¯¹è±¡ï¼Œä½¿ç”¨ **Scavenge ç®—æ³•**ï¼ˆå¤åˆ¶+æ¸…ç†ï¼‰ï¼ŒGC é¢‘ç¹ï¼›
> - **è€ç”Ÿä»£**ï¼ˆOld Generationï¼‰ï¼šé•¿æœŸå­˜æ´»å¯¹è±¡ï¼Œä½¿ç”¨ **æ ‡è®°-æ¸…é™¤ + æ ‡è®°-æ•´ç†**ï¼ŒGC è¾ƒå°‘ã€‚

#### âš ï¸ 2. å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰ã€å·²æ·˜æ±°ã€‘

- **åŸç†**ï¼šæ¯ä¸ªå¯¹è±¡è®°å½•è¢«å¼•ç”¨æ¬¡æ•°ï¼Œä¸º 0 æ—¶å›æ”¶ã€‚
- **ç¼ºé™·**ï¼šæ— æ³•å¤„ç†**å¾ªç¯å¼•ç”¨**ï¼ˆå¦‚ `a.b = b; b.a = a`ï¼‰ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚
- **ç°çŠ¶**ï¼šç°ä»£ JS å¼•æ“ï¼ˆV8ã€SpiderMonkeyï¼‰**ä¸å†ä½¿ç”¨**æ­¤ç®—æ³•ã€‚

> âŒ ä¸è¦å†è®¤ä¸ºâ€œJS ä½¿ç”¨å¼•ç”¨è®¡æ•°â€â€”â€”è¿™æ˜¯è¿‡æ—¶è®¤çŸ¥ï¼

## äºŒã€å†…å­˜æ³„æ¼ï¼ˆMemory Leakï¼‰

### 2.1 ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿ

> **å†…å­˜æ³„æ¼**ï¼šç¨‹åºä¸­**ä¸å†ä½¿ç”¨çš„å¯¹è±¡**ï¼Œå› ä»å­˜åœ¨**æœ‰æ•ˆå¼•ç”¨**ï¼Œå¯¼è‡´ GC æ— æ³•å›æ”¶ï¼Œä»è€ŒæŒç»­å ç”¨å†…å­˜ã€‚

- å¼•æ“å°½åŠ›å›æ”¶åƒåœ¾ï¼Œä½†**æ— æ³•è¯†åˆ«â€œé€»è¾‘ä¸Šæ— ç”¨ä½†æŠ€æœ¯ä¸Šæœ‰å¼•ç”¨â€çš„å¯¹è±¡**ï¼›
- æ³„æ¼ç§¯ç´¯ â†’ å†…å­˜è†¨èƒ€ â†’ é¡µé¢å¡é¡¿/å´©æºƒã€‚
 
### 2.2 å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯

#### åœºæ™¯ 1ï¼šä¸æ­£å½“çš„é—­åŒ…

```js
// âŒ æ³„æ¼ï¼šå†…éƒ¨å‡½æ•°å¼•ç”¨äº†å¤–éƒ¨å¤§æ•°ç»„
function createLeak() {
  const bigData = new Array(10000).fill('*');
  return () => console.log(bigData.length); // ä¿æŒå¯¹ bigData çš„å¼•ç”¨
}
const leakyFn = createLeak();
leakyFn(); // å³ä½¿ä¸å†è°ƒç”¨ï¼ŒbigData ä¹Ÿæ— æ³• GC

// âœ… ä¿®å¤ï¼šè§£é™¤å¼•ç”¨
leakyFn = null; // æ­¤æ—¶ bigData å¯è¢«å›æ”¶
```

> ğŸ” **å…³é”®ç‚¹**ï¼šé—­åŒ…æœ¬èº«ä¸æ˜¯é—®é¢˜ï¼Œ**æŒæœ‰æ— ç”¨å¤§å¯¹è±¡å¼•ç”¨ä¸”ä¸é‡Šæ”¾**æ‰æ˜¯é—®é¢˜ã€‚
 
#### åœºæ™¯ 2ï¼šéšå¼å…¨å±€å˜é‡

```js
function fn() {
  undeclaredVar = {};       // æ²¡æœ‰ var/let/const â†’ æŒ‚åˆ° window
  this.anotherGlobal = [];  // åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œthis æŒ‡å‘ window
}
fn();
// undeclaredVar å’Œ anotherGlobal æˆä¸ºå…¨å±€å˜é‡ï¼Œæ°¸ä¸å›æ”¶ï¼
```

âœ… **é¢„é˜²æªæ–½**ï¼š
- ä½¿ç”¨ **ä¸¥æ ¼æ¨¡å¼**ï¼ˆ`'use strict'`ï¼‰
- å¯ç”¨ ESLint è§„åˆ™ï¼ˆå¦‚ `no-undef`ï¼‰
 
#### åœºæ™¯ 3ï¼šæ¸¸ç¦» DOM å¼•ç”¨ï¼ˆDetached DOMï¼‰

```html
<div id="parent">
  <div id="child"></div>
</div>
<script>
  const parent = document.getElementById('parent');
  const child = document.getElementById('child');

  parent.remove(); // DOM ä»é¡µé¢ç§»é™¤

  // âŒ child ä»æŒæœ‰å¯¹ DOM èŠ‚ç‚¹çš„å¼•ç”¨ â†’ æ•´æ£µå­æ ‘æ— æ³• GC
  console.log(child.innerHTML); 

  // âœ… ä¿®å¤ï¼šç½®ç©ºå¼•ç”¨
  child = null;
</script>
```

> ğŸ’¡ å³ä½¿ DOM ä»é¡µé¢ç§»é™¤ï¼Œåªè¦ JS å˜é‡ä»å¼•ç”¨å®ƒï¼Œæ•´æ£µå­æ ‘éƒ½ä¼šé©»ç•™å†…å­˜ã€‚
 
#### åœºæ™¯ 4ï¼šæœªæ¸…é™¤çš„å®šæ—¶å™¨ä¸å›è°ƒ

```js
const data = fetchData(); // å¤§å¯¹è±¡

setInterval(() => {
  // å›è°ƒå‡½æ•°å¼•ç”¨äº† data â†’ data æ— æ³• GC
  updateUI(data);
}, 1000);

// âŒ å¿˜è®° clearInterval â†’ å®šæ—¶å™¨å’Œ data æ°¸ä¹…é©»ç•™
```

âœ… **è§£å†³æ–¹æ¡ˆ**ï¼š
- ç»„ä»¶é”€æ¯æ—¶æ¸…é™¤ï¼š`clearInterval`, `clearTimeout`
- åŠ¨ç”»ä½¿ç”¨ `cancelAnimationFrame`
 
#### åœºæ™¯ 5ï¼šæœªç§»é™¤çš„äº‹ä»¶ç›‘å¬å™¨

```js
// Vue ç¤ºä¾‹
export default {
  mounted() {
    window.addEventListener('resize', this.handler);
  },
  beforeUnmount() {
    // âŒ å¿˜è®°ç§»é™¤ â†’ handler å’Œç»„ä»¶å®ä¾‹æ— æ³• GC
    // âœ… æ­£ç¡®åšæ³•ï¼š
    window.removeEventListener('resize', this.handler);
  }
}
```

> âš ï¸ å°¤å…¶æ³¨æ„ï¼š**å…¨å±€äº‹ä»¶**ï¼ˆå¦‚ `window`ã€`document`ï¼‰å¿…é¡»æ‰‹åŠ¨ç§»é™¤ï¼
 
#### åœºæ™¯ 6ï¼šç›‘å¬è€…æ¨¡å¼ï¼ˆEventBus / PubSubï¼‰

```js
// è®¢é˜…äº‹ä»¶
eventBus.on('update', this.handleUpdate);

// âŒ ç»„ä»¶é”€æ¯æ—¶æœªå–æ¶ˆè®¢é˜… â†’ handleUpdate å’Œç»„ä»¶å®ä¾‹æ— æ³•é‡Šæ”¾

// âœ… ä¿®å¤
eventBus.off('update', this.handleUpdate);
```

> ğŸ”” æ‰€æœ‰è‡ªå®šä¹‰äº‹ä»¶ç³»ç»Ÿéƒ½éœ€é…å¥—â€œå–æ¶ˆè®¢é˜…â€æœºåˆ¶ã€‚
 
#### åœºæ™¯ 7ï¼šå¼ºå¼•ç”¨å®¹å™¨ï¼ˆMap / Setï¼‰

```js
const cache = new Map();
cache.set(someObj, largeData);

// âŒ someObj å³ä½¿å…¶ä»–åœ°æ–¹ä¸å†ä½¿ç”¨ï¼Œä»è¢« cache å¼ºå¼•ç”¨ â†’ æ— æ³• GC

// âœ… æ”¹ç”¨ WeakMapï¼ˆé”®ä¸ºå¼±å¼•ç”¨ï¼‰
const weakCache = new WeakMap();
weakCache.set(someObj, largeData); // å½“ someObj æ— å…¶ä»–å¼•ç”¨æ—¶ï¼Œè‡ªåŠ¨å›æ”¶
```

| å®¹å™¨ | å¼•ç”¨ç±»å‹ | æ˜¯å¦é˜»ç¢ GC |
|------|--------|-----------|
| `Object` / `Map` / `Set` | å¼ºå¼•ç”¨ | âœ… æ˜¯ |
| `WeakMap` / `WeakSet` | å¼±å¼•ç”¨ï¼ˆä»…å¯¹é”®ï¼‰ | âŒ å¦ |

> ğŸ’¡ `WeakMap` é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œå€¼å¯ä¸ºä»»æ„ç±»å‹ï¼›é€‚åˆåš**ç§æœ‰æ•°æ®å­˜å‚¨**æˆ–**ç¼“å­˜**ã€‚
 
#### åœºæ™¯ 8ï¼šæœªæ¸…ç†çš„ `console` è¾“å‡ºï¼ˆæ˜“å¿½ç•¥ï¼ï¼‰

```js
function Test() {
  this.data = new Array(10000).fill('*');
  console.log(this); // âŒ æµè§ˆå™¨ä¼šä¿ç•™å¯¹ this çš„å¼•ç”¨ï¼
}
new Test(); // å³ä½¿æ— å˜é‡å¼•ç”¨ï¼Œä¹Ÿå¯èƒ½å›  console å¯¼è‡´æ³„æ¼
```

âœ… **å»ºè®®**ï¼š
- å¼€å‘ç¯å¢ƒï¼šå¯ä¿ç•™ `console`
- ç”Ÿäº§ç¯å¢ƒï¼š**åŠ¡å¿…ç§»é™¤**æˆ–é€šè¿‡æ„å»ºå·¥å…·è‡ªåŠ¨å‰¥ç¦»
 
## ä¸‰ã€å†…å­˜æ³„æ¼æ’æŸ¥ä¸å®šä½ï¼ˆChrome DevToolsï¼‰

### 3.1 åˆæ­¥æ£€æµ‹ï¼šPerformance é¢æ¿

1. æ‰“å¼€ **æ— ç—•æ¨¡å¼**ï¼ˆé¿å…æ’ä»¶å¹²æ‰°ï¼‰
2. è¿›å…¥ **DevTools â†’ Performance**
3. å‹¾é€‰ **Memory**
4. å½•åˆ¶æ“ä½œï¼ˆå¦‚ç‚¹å‡»æŒ‰é’® 100 æ¬¡ï¼‰
5. è§‚å¯Ÿ **Heapï¼ˆå †å†…å­˜ï¼‰æ›²çº¿**ï¼š
   - æ­£å¸¸ï¼šé”¯é½¿çŠ¶ï¼ˆGC åå›è½ï¼‰
   - æ³„æ¼ï¼š**æŒç»­ä¸Šå‡ï¼ŒGC åæ— æ˜æ˜¾ä¸‹é™**

> ğŸ“ˆ å³ä½¿æ‰‹åŠ¨è§¦å‘ GCï¼ˆç‚¹å‡» ğŸ—‘ï¸ï¼‰ï¼Œå†…å­˜ä»ä¸ä¸‹é™ â†’ å­˜åœ¨æ³„æ¼ã€‚
 
### 3.2 ç²¾ç¡®å®šä½ï¼šMemory é¢æ¿ï¼ˆHeap Snapshotï¼‰

1. è¿›å…¥ **DevTools â†’ Memory**
2. æ“ä½œå‰ï¼šç‚¹å‡» ğŸ—‘ï¸ æ‰§è¡Œ GCï¼Œç„¶åæ‹ **Snapshot 1**
3. æ‰§è¡Œå¯ç–‘æ“ä½œï¼ˆå¦‚ç‚¹å‡»æŒ‰é’®ï¼‰
4. å†æ¬¡ GCï¼Œæ‹ **Snapshot 2**
5. é€‰ä¸­ Snapshot 2 â†’ é€‰æ‹© **Comparison**ï¼ˆå¯¹æ¯” Snapshot 1ï¼‰

ğŸ” **é‡ç‚¹å…³æ³¨**ï¼š
- `Delta > 0` çš„é¡¹ï¼ˆæ–°å¢æœªå›æ”¶å¯¹è±¡ï¼‰
- `Constructor` åˆ—ï¼š
  - `closure`ï¼šé—­åŒ…æ³„æ¼
  - `(array)` / `(object)`ï¼šå¤§å¯¹è±¡æœªé‡Šæ”¾
  - `HTMLDivElement` ç­‰ï¼šDOM æ³„æ¼

> ğŸ’¡ ç‚¹å‡»å…·ä½“æ¡ç›®å¯æŸ¥çœ‹**å¼•ç”¨è·¯å¾„**ï¼ˆRetainersï¼‰ï¼Œå®šä½åˆ°æºç è¡Œå·ã€‚
 
## å››ã€æ€»ç»“ï¼šå¦‚ä½•é¿å…å†…å­˜æ³„æ¼ï¼Ÿ

| åœºæ™¯ | é¢„é˜²æªæ–½ |
|------|--------|
| é—­åŒ… | ä¸æŒæœ‰æ— ç”¨å¤§å¯¹è±¡ï¼›ç”¨å®Œè®¾ä¸º `null` |
| å…¨å±€å˜é‡ | é¿å…éšå¼å…¨å±€ï¼›ç”¨å®Œç½® `null` |
| DOM å¼•ç”¨ | ç§»é™¤èŠ‚ç‚¹åï¼Œæ¸…é™¤ JS å¼•ç”¨ |
| å®šæ—¶å™¨/äº‹ä»¶ | ç»„ä»¶é”€æ¯æ—¶æ¸…é™¤ï¼ˆ`clearXxx`, `removeEventListener`ï¼‰ |
| EventBus | è®¢é˜…ååŠ¡å¿…å–æ¶ˆï¼ˆ`off`ï¼‰ |
| ç¼“å­˜ | ä¼˜å…ˆä½¿ç”¨ `WeakMap` / `WeakSet` |
| Console | ç”Ÿäº§ç¯å¢ƒç§»é™¤æ—¥å¿— |
| å¤§æ•°ç»„/å¯¹è±¡ | æ˜¾å¼é‡Šæ”¾ï¼š`arr = null` |
 
## äº”ã€æ‰©å±•ï¼šå‰ç«¯å†…å­˜â€œä¸‰å¤§ä»¶â€

| é—®é¢˜ | è¡¨ç° | è§£å†³æ–¹å‘ |
|------|------|--------|
| **å†…å­˜æ³„æ¼** | å†…å­˜æŒç»­å¢é•¿ï¼ŒGC æ— æ³•å›æ”¶ | æ¶ˆé™¤æ— æ•ˆå¼•ç”¨ |
| **å†…å­˜è†¨èƒ€** | çŸ­æ—¶é—´å†…å†…å­˜é£™å‡ | å‡å°‘ä¸€æ¬¡æ€§å¤§å¯¹è±¡åˆ›å»º |
| **é¢‘ç¹ GC** | é¡µé¢å¡é¡¿ï¼ˆGC åœé¡¿ï¼‰ | é¿å…å¤§é‡ä¸´æ—¶å˜é‡ |

> ğŸŒŸ **æ ¸å¿ƒåŸåˆ™**ï¼š**è®©æ— ç”¨æ•°æ®å¤±å»æ‰€æœ‰å¼•ç”¨**ï¼ŒGC æ‰èƒ½å›æ”¶ã€‚
 
> âœ… **æœ€åå»ºè®®**ï¼š  
> å†…å­˜é—®é¢˜å¾€å¾€åœ¨**é•¿æœŸè¿è¡Œ**åæš´éœ²ã€‚å¼€å‘æ—¶å…»æˆè‰¯å¥½ä¹ æƒ¯ï¼Œä¸Šçº¿å‰ç”¨ DevTools åšä¸€æ¬¡å†…å­˜å¿«ç…§åˆ†æï¼Œå¯é¿å… 90% çš„æ€§èƒ½éšæ‚£ã€‚

## å…­ã€é«˜é¢‘é¢è¯•é¢˜ï¼ˆè¿›é˜¶ç‰ˆï¼‰

### Q1ï¼šJavaScript çš„åƒåœ¾å›æ”¶æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼ŸV8 å¼•æ“å…·ä½“ä½¿ç”¨äº†å“ªäº›ç­–ç•¥ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š  
JavaScript å¼•æ“é€šè¿‡**è‡ªåŠ¨åƒåœ¾å›æ”¶**ï¼ˆGCï¼‰ç®¡ç†å†…å­˜ã€‚ç°ä»£å¼•æ“ï¼ˆå¦‚ V8ï¼‰ä¸»è¦é‡‡ç”¨ **æ ‡è®°-æ¸…é™¤**ï¼ˆMark-and-Sweepï¼‰ç®—æ³•ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šå¼•å…¥ **åˆ†ä»£å›æ”¶**ï¼ˆGenerational GCï¼‰ä»¥æå‡æ€§èƒ½ã€‚

V8 å°†å †å†…å­˜åˆ†ä¸ºï¼š
- **æ–°ç”Ÿä»£**ï¼ˆYoung Generationï¼‰ï¼šå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œç©ºé—´å°ã€GC é¢‘ç¹ã€‚ä½¿ç”¨ **Scavenge ç®—æ³•**ï¼ˆCheney å¤åˆ¶ç®—æ³•ï¼‰ï¼Œå°†å­˜æ´»å¯¹è±¡ä» From-Space å¤åˆ¶åˆ° To-Spaceï¼Œç„¶åæ•´ä½“é‡Šæ”¾ã€‚
- **è€ç”Ÿä»£**ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œç©ºé—´å¤§ã€GC è¾ƒå°‘ã€‚ä½¿ç”¨ **æ ‡è®°-æ¸…é™¤ + æ ‡è®°-æ•´ç†**ï¼ˆMark-Compactï¼‰é¿å…å†…å­˜ç¢ç‰‡ã€‚

æ­¤å¤–ï¼ŒV8 è¿˜æœ‰ï¼š
- **å¢é‡æ ‡è®°**ï¼ˆIncremental Markingï¼‰ï¼šå°† GC å·¥ä½œæ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡ï¼Œé¿å…ä¸»çº¿ç¨‹é•¿æ—¶é—´é˜»å¡ï¼›
- **å¹¶å‘/å¹¶è¡Œå›æ”¶**ï¼šåˆ©ç”¨å¤šæ ¸ CPU æå‡ GC æ•ˆç‡ã€‚

> âœ… è€ƒå¯Ÿç‚¹ï¼šæ˜¯å¦äº†è§£ V8 çš„å·¥ç¨‹ä¼˜åŒ–ï¼Œè€Œéä»…åœç•™åœ¨â€œæ ‡è®°æ¸…é™¤â€è¡¨é¢ã€‚
 
### Q2ï¼šé—­åŒ…ä¸€å®šä¼šå¯¼è‡´å†…å­˜æ³„æ¼å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š  
**ä¸ä¼š**ã€‚é—­åŒ…æœ¬èº«æ˜¯ JavaScript çš„æ­£å¸¸è¯­è¨€ç‰¹æ€§ï¼Œ**åªæœ‰å½“é—­åŒ…æŒæœ‰å¯¹æ— ç”¨å¤§å¯¹è±¡çš„å¼•ç”¨ä¸”é•¿æœŸä¸é‡Šæ”¾æ—¶ï¼Œæ‰å¯èƒ½é€ æˆå†…å­˜æ³„æ¼**ã€‚

ä¾‹å¦‚ï¼š
```js
function counter() {
  let count = 0;
  return () => ++count; // é—­åŒ…å¼•ç”¨ä¸€ä¸ª numberï¼Œå†…å­˜å¼€é”€æå°
}
```
è¿™ç§è½»é‡é—­åŒ…å®Œå…¨å®‰å…¨ã€‚

ä½†è‹¥ï¼š
```js
function leaky() {
  const hugeData = new Array(1e6).fill('*');
  return () => console.log(hugeData.length); // ä¿æŒå¯¹å¤§æ•°ç»„çš„å¼•ç”¨
}
```
ä¸”è¿”å›çš„å‡½æ•°é•¿æœŸå­˜åœ¨ï¼ˆå¦‚æŒ‚åˆ°å…¨å±€ï¼‰ï¼Œåˆ™ `hugeData` æ— æ³•è¢« GCï¼Œå½¢æˆæ³„æ¼ã€‚

> âœ… å…³é”®ç»“è®ºï¼š**é—­åŒ… â‰  å†…å­˜æ³„æ¼**ï¼Œé—®é¢˜åœ¨äºâ€œæ˜¯å¦æŒæœ‰ä¸å¿…è¦çš„å¼ºå¼•ç”¨â€ã€‚
 
### Q3ï¼š`WeakMap` å’Œ `Map` åœ¨å†…å­˜ç®¡ç†ä¸Šæœ‰ä½•æœ¬è´¨åŒºåˆ«ï¼Ÿä»€ä¹ˆåœºæ™¯ä¸‹å¿…é¡»ä½¿ç”¨ `WeakMap`ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š  
- `Map` å¯¹**é”®**ï¼ˆkeyï¼‰æŒ**å¼ºå¼•ç”¨**ï¼Œåªè¦ Map å­˜åœ¨ï¼Œé”®å¯¹è±¡å°±ä¸ä¼šè¢« GCï¼›
- `WeakMap` å¯¹**é”®**æŒ**å¼±å¼•ç”¨**ï¼Œè‹¥è¯¥é”®åœ¨å…¶ä»–åœ°æ–¹æ— å¼•ç”¨ï¼Œåˆ™å³ä½¿ WeakMap å­˜åœ¨ï¼Œé”®ä¹Ÿä¼šè¢«å›æ”¶ã€‚

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
1. **ç§æœ‰æ•°æ®å­˜å‚¨**ï¼ˆæ›¿ä»£é—­åŒ…æˆ– Symbolï¼‰ï¼š
   ```js
   const privateData = new WeakMap();
   class User {
     constructor(name) {
       privateData.set(this, { name });
     }
     getName() {
       return privateData.get(this).name;
     }
   }
   // å½“ User å®ä¾‹è¢« GCï¼Œå…¶ç§æœ‰æ•°æ®è‡ªåŠ¨æ¶ˆå¤±
   ```
2. **DOM å…ƒç´ å…ƒæ•°æ®ç¼“å­˜**ï¼š
   ```js
   const metadata = new WeakMap();
   function attachMetadata(el, data) {
     metadata.set(el, data);
   }
   // el è¢«ç§»é™¤åï¼Œmetadata è‡ªåŠ¨æ¸…ç†
   ```

> âš ï¸ æ³¨æ„ï¼š`WeakMap` çš„ key å¿…é¡»æ˜¯**å¯¹è±¡**ï¼Œä¸”ä¸å¯éå†ï¼ˆæ—  `.keys()`ã€`.values()`ï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯ GC ä¸å—å¹²æ‰°ã€‚
 
### Q4ï¼šå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªé¡µé¢æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ï¼Ÿè¯·æè¿°å®Œæ•´çš„æ’æŸ¥æµç¨‹ã€‚

**æ ‡å‡†å›ç­”**ï¼š  
å¯é€šè¿‡ Chrome DevTools åˆ†ä¸¤æ­¥å®šä½ï¼š

#### ç¬¬ä¸€æ­¥ï¼šPerformance é¢æ¿åˆç­›
1. æ‰“å¼€æ— ç—•çª—å£ï¼ˆé¿å…æ’ä»¶å¹²æ‰°ï¼‰
2. DevTools â†’ Performance â†’ å‹¾é€‰ **Memory**
3. å½•åˆ¶ç”¨æˆ·æ“ä½œï¼ˆå¦‚åå¤æ‰“å¼€/å…³é—­å¼¹çª—ï¼‰
4. è§‚å¯Ÿ **JS Heap æ›²çº¿**ï¼š
   - æ­£å¸¸ï¼šé”¯é½¿çŠ¶ï¼ŒGC åæ˜æ˜¾å›è½
   - æ³„æ¼ï¼š**æŒç»­ä¸Šå‡ï¼Œæ‰‹åŠ¨ GC åä»ä¸ä¸‹é™**

#### ç¬¬äºŒæ­¥ï¼šMemory é¢æ¿ç²¾ç¡®å®šä½
1. DevTools â†’ Memory
2. æ“ä½œå‰ï¼šå¼ºåˆ¶ GC â†’ æ‹ **Snapshot 1**
3. æ‰§è¡Œå¯ç–‘æ“ä½œï¼ˆå¦‚ç‚¹å‡» 100 æ¬¡æŒ‰é’®ï¼‰
4. å†æ¬¡ GC â†’ æ‹ **Snapshot 2**
5. é€‰æ‹© **Comparison** æ¨¡å¼ï¼Œå¯¹æ¯”ä¸¤ä¸ªå¿«ç…§
6. æŸ¥çœ‹ **Delta > 0** çš„å¯¹è±¡ï¼š
   - è‹¥å¤§é‡ `(closure)`ã€`HTMLDivElement`ã€`(array)` æŒç»­å¢é•¿ â†’ å®šä½åˆ°é—­åŒ…ã€DOMã€å¤§æ•°ç»„æ³„æ¼
7. ç‚¹å‡»å¯¹è±¡ â†’ æŸ¥çœ‹ **Retainers**ï¼ˆå¼•ç”¨é“¾ï¼‰â†’ å®šä½åˆ°å…·ä½“ä»£ç ä½ç½®

> âœ… é«˜é˜¶æŠ€å·§ï¼šä½¿ç”¨ **Allocation instrumentation on timeline** æ¨¡å¼ï¼Œå®æ—¶ç›‘æ§æ–°åˆ†é…å¯¹è±¡ã€‚
 
### Q5ï¼šåœ¨ React / Vue ä¸­ï¼Œå“ªäº›å†™æ³•å®¹æ˜“å¼•å‘å†…å­˜æ³„æ¼ï¼Ÿå¦‚ä½•è§„é¿ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š  

#### å¸¸è§æ³„æ¼ç‚¹ï¼š
| æ¡†æ¶ | åœºæ™¯ | åŸå›  |
|------|------|------|
| **React** | `useEffect` ä¸­æœªæ¸…ç†å‰¯ä½œç”¨ | å¦‚æœªæ¸…é™¤ `setTimeout`ã€æœªç§»é™¤äº‹ä»¶ç›‘å¬ |
| **Vue 2/3** | `mounted` / `onMounted` ä¸­ç»‘å®šå…¨å±€äº‹ä»¶ | æœªåœ¨ `beforeUnmount` ä¸­è§£ç»‘ |
| **é€šç”¨** | ç»„ä»¶å†…ç¼“å­˜å¤§å¯¹è±¡åˆ°å…¨å±€å˜é‡ | å¦‚ `window.cache = bigData` |

#### è§„é¿æ–¹æ¡ˆï¼š

âœ… **React ç¤ºä¾‹**ï¼š
```jsx
useEffect(() => {
  const timer = setTimeout(() => { /* ... */ }, 1000);
  const handleResize = () => { /* ... */ };
  window.addEventListener('resize', handleResize);

  return () => {
    clearTimeout(timer); // æ¸…é™¤å®šæ—¶å™¨
    window.removeEventListener('resize', handleResize); // ç§»é™¤ç›‘å¬
  };
}, []);
```

âœ… **Vue 3 ç¤ºä¾‹**ï¼š
```js
onMounted(() => {
  eventBus.on('update', handler);
});
onBeforeUnmount(() => {
  eventBus.off('update', handler); // å–æ¶ˆè®¢é˜…
});
```

âœ… **é€šç”¨åŸåˆ™**ï¼š
- æ‰€æœ‰**å‰¯ä½œç”¨**ï¼ˆå®šæ—¶å™¨ã€äº‹ä»¶ã€è®¢é˜…ã€WebSocketï¼‰å¿…é¡»åœ¨ç»„ä»¶é”€æ¯æ—¶æ¸…ç†ï¼›
- é¿å…åœ¨ç»„ä»¶å†…åˆ›å»º**å…¨å±€å¼•ç”¨**ï¼›
- ä½¿ç”¨ `WeakMap` ç¼“å­˜ç»„ä»¶å®ä¾‹ç›¸å…³æ•°æ®ã€‚

> ğŸ’¡ é¢è¯•åŠ åˆ†é¡¹ï¼šæåˆ° **React çš„ StrictMode åŒæ¸²æŸ“æœºåˆ¶å¯èƒ½æ©ç›–æ³„æ¼é—®é¢˜**ï¼Œéœ€åœ¨ç”Ÿäº§æ„å»ºä¸­æµ‹è¯•ã€‚
 
## é™„ï¼šé¢è¯•å›ç­”é»„é‡‘ç»“æ„

å½“ä½ è¢«é—®åˆ°å†…å­˜ç›¸å…³é—®é¢˜æ—¶ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é€»è¾‘ç»„ç»‡ç­”æ¡ˆï¼š

1. **å®šä¹‰æ¦‚å¿µ**ï¼ˆWhatï¼‰  
2. **è§£é‡ŠåŸç†/æœºåˆ¶**ï¼ˆHow / Whyï¼‰  
3. **ä¸¾å‡ºæ­£åä¾‹**ï¼ˆExampleï¼‰  
4. **è¯´æ˜å½±å“ä¸åæœ**ï¼ˆImpactï¼‰  
5. **ç»™å‡ºè§£å†³æ–¹æ¡ˆ/æœ€ä½³å®è·µ**ï¼ˆSolutionï¼‰  
6. **å»¶ä¼¸å·¥å…·æˆ–åº•å±‚ç»†èŠ‚**ï¼ˆBonusï¼‰

> ğŸŒŸ è¿™ç§ç»“æ„å±•ç°ä½ ä¸ä»…â€œçŸ¥é“â€ï¼Œè€Œä¸”â€œç†è§£â€å’Œâ€œä¼šç”¨â€ã€‚
